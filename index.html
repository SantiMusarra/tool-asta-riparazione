<!--!
 * Fanta Rescue
 *
 * Copyright (C) 2026 Musarra Santi
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 *
 * SPDX-License-Identifier: GPL-3.0-or-later
 -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanta Rescue - Fantacalcio Tool</title>
    <!-- SheetJS per leggere Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252542;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b8;
            --accent: #6c5ce7;
            --accent-hover: #a29bfe;
            --accent-secondary: #00cec9;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --border: #3d3d5c;
            --gold: #f1c40f;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* ===== WELCOME PAGE ===== */
        #welcome-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: 
                radial-gradient(ellipse at center, rgba(108, 92, 231, 0.1) 0%, transparent 70%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }
        
        .welcome-container {
            text-align: center;
            max-width: 700px;
        }
        
        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }
        
        .hero-row {
            display: flex;
            gap: 25px;
            align-items: stretch;
            margin-bottom: 25px;
            max-width: 750px;
        }
        
        @media (max-width: 700px) {
            .hero-row {
                flex-direction: column;
            }
        }
        
        .upload-zone {
            border: 2px dashed var(--accent);
            border-radius: 15px;
            padding: 30px 25px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 220px;
        }
        
        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent-secondary);
            background: rgba(108, 92, 231, 0.1);
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(108, 92, 231, 0.3);
        }
        
        .upload-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .features-box {
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1));
            border-radius: 12px;
            border: 1px solid rgba(76, 175, 80, 0.3);
            text-align: left;
            flex: 1.3;
        }
        
        .features-list {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }
        
        .features-list li {
            padding: 6px 0 6px 24px;
            position: relative;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .features-list li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }
        
        .features-privacy {
            margin: 0;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .instructions-box {
            margin-top: 30px;
            padding: 25px;
            background: var(--bg-card);
            border-radius: 15px;
            text-align: left;
            border: 1px solid var(--border);
        }
        
        .instructions-box h4 {
            color: var(--gold);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions-list {
            list-style: none;
            counter-reset: steps;
        }
        
        .instructions-list li {
            counter-increment: steps;
            padding: 10px 0;
            padding-left: 45px;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border);
        }
        
        .instructions-list li:last-child {
            border-bottom: none;
        }
        
        .instructions-list li::before {
            content: counter(steps);
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .instructions-list li a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .instructions-list li a:hover {
            text-decoration: underline;
            color: var(--accent-hover);
        }
        
        .instructions-list li code {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--warning);
            font-size: 0.9rem;
        }
        
        .instruction-screenshot {
            margin-top: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            position: relative;
        }
        
        .instruction-screenshot img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }
        
        .instruction-screenshot img:hover {
            transform: scale(1.02);
        }
        
        .mobile-note {
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .mobile-note-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .mobile-note-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex: 1;
        }
        
        .mobile-note-thumb {
            width: 60px;
            height: auto;
            border-radius: 6px;
            border: 1px solid var(--border);
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .mobile-note-thumb:hover {
            transform: scale(1.1);
        }
        
        /* Lightbox Modal */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }
        
        .lightbox-overlay.active {
            display: flex;
        }
        
        .lightbox-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: lightbox-zoom 0.2s ease;
        }
        
        @keyframes lightbox-zoom {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .lightbox-close:hover {
            opacity: 1;
        }
        
        .file-format {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: left;
            border-left: 4px solid var(--accent);
        }
        
        .file-format h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .file-format ul {
            list-style: none;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .file-format li {
            padding: 3px 0;
        }
        
        .file-format li::before {
            content: "✓ ";
            color: var(--success);
        }
        
        .disclaimer {
            margin-top: 20px;
            padding: 15px 20px;
            background: rgba(233, 69, 96, 0.15);
            border: 1px solid var(--danger);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--danger);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            text-align: left;
        }
        
        .disclaimer-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .error-message {
            margin-top: 20px;
            padding: 15px;
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--danger);
            border-radius: 10px;
            color: var(--danger);
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--accent);
        }
        
        /* ===== MAIN APP ===== */
        #main-app {
            display: none;
        }
        
        #main-app.active {
            display: block;
        }
        
        .header {
            background: linear-gradient(90deg, var(--bg-secondary), var(--bg-card));
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.5rem;
            color: var(--gold);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .file-info {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 0 15px rgba(0, 179, 65, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
            border-color: #c0392b;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            padding: 0 20px;
            gap: 5px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 68px; /* altezza header */
            z-index: 99;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--text-primary);
            background: rgba(0, 179, 65, 0.1);
        }
        
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* Content */
        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Config Hint Box */
        .config-hint-box {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.15), rgba(0, 206, 201, 0.1));
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .config-hint-box span:first-child {
            font-size: 1.5rem;
        }
        
        .btn-config-link {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .btn-config-link:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        /* Mobile Warning */
        .mobile-warning {
            border-color: var(--warning);
            background: rgba(253, 203, 110, 0.1);
        }
        
        /* Privacy Notice */
        .privacy-notice {
            border-color: var(--success);
            background: rgba(0, 184, 148, 0.1);
        }
        
        /* File Naming */
        .file-naming {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.1);
        }
        
        .file-naming code {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        /* Legenda */
        .legenda-box {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .legenda-box h4 {
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 0.95rem;
        }
        
        .legenda-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 25px;
        }
        
        .legenda-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Info Box */
        .info-box {
            background: rgba(108, 92, 231, 0.1);
            border-left: 3px solid var(--accent);
            border-radius: 0 8px 8px 0;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .info-box .info-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        /* Help Text */
        .help-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        /* Optional Badge */
        .optional-badge {
            background: var(--text-secondary);
            color: var(--bg-primary);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
            font-weight: normal;
            vertical-align: middle;
        }
        
        /* Mercato Details */
        .mercato-details {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .mercato-details summary {
            padding: 15px;
            cursor: pointer;
            font-weight: 500;
            color: var(--accent);
            list-style: none;
        }
        
        .mercato-details summary::-webkit-details-marker {
            display: none;
        }
        
        .mercato-details summary::before {
            content: "▶ ";
            font-size: 0.8rem;
        }
        
        .mercato-details[open] summary::before {
            content: "▼ ";
        }
        
        .mercato-details[open] > *:not(summary) {
            padding: 0 15px 15px;
        }
        
        /* Privacy inline box in Svincoli tab */
        .privacy-inline {
            background: rgba(0, 184, 148, 0.1);
            border-color: var(--success);
        }
        
        /* Budget Cards */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .budget-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .budget-card h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: var(--gold);
        }
        
        .budget-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9rem;
        }
        
        .budget-row.total {
            border-top: 1px solid var(--border);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .budget-row.total .value {
            color: var(--success);
        }
        
        .budget-total-lega {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.15);
        }
        
        .budget-total-lega h2 {
            color: var(--gold);
            font-size: 1.8rem;
        }
        
        /* Quick Search */
        .quick-search-container {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .quick-search-container h3 {
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .quick-search-wrapper {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .quick-search-wrapper input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .quick-search-wrapper input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(0, 179, 65, 0.3);
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 80px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .autocomplete-list.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        
        .autocomplete-item:hover {
            background: var(--bg-card);
        }
        
        .autocomplete-item.svincolato {
            background: rgba(0, 206, 201, 0.1);
            border-left: 3px solid var(--secondary);
        }
        
        .autocomplete-item.svincolato:hover {
            background: rgba(0, 206, 201, 0.2);
        }
        
        .autocomplete-item .squadra {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Squadra sections */
        .squadra-section {
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .squadra-header {
            padding: 15px 20px;
            background: linear-gradient(90deg, var(--bg-secondary), var(--bg-card));
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .squadra-header:hover {
            background: linear-gradient(90deg, var(--bg-card), var(--bg-secondary));
        }
        
        .squadra-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gold);
        }
        
        .squadra-header .counter {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: normal;
        }
        
        .svincoli-summary {
            display: inline-flex;
            gap: 6px;
            margin-left: 10px;
        }
        
        .ruolo-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
        }
        
        .ruolo-badge.P {
            background-color: #f5a623;
        }
        
        .ruolo-badge.D {
            background-color: #4caf50;
        }
        
        .ruolo-badge.C {
            background-color: #2196f3;
        }
        
        .ruolo-badge.A {
            background-color: #f44336;
        }
        
        .squadra-header .toggle-icon {
            transition: transform 0.3s;
            color: var(--accent);
        }
        
        .squadra-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .squadra-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .squadra-content.collapsed {
            max-height: 0;
        }
        
        .squadra-actions {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-reset {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-reset:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-secondary);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            color: var(--accent);
        }
        
        th:hover {
            background: var(--bg-card);
        }
        
        th .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        
        th.sorted .sort-icon {
            opacity: 1;
        }
        
        tr:hover {
            background: rgba(108, 92, 231, 0.08);
        }
        
        tr.fuori-lista {
            background: rgba(214, 48, 49, 0.15);
        }
        
        tr.svincolato {
            background: rgba(255, 215, 0, 0.15);
        }
        
        tr.preferito {
            background: rgba(108, 92, 231, 0.1);
        }
        
        /* Checkbox styling */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }
        
        /* Stars Rating */
        .stars-cell {
            white-space: nowrap;
        }
        
        .stars-rating {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .star {
            cursor: pointer;
            font-size: 1.1rem;
            color: #555;
            transition: all 0.15s;
            user-select: none;
        }
        
        .star:hover {
            transform: scale(1.2);
        }
        
        .star.filled {
            color: var(--gold);
            text-shadow: 0 0 5px rgba(241, 196, 15, 0.5);
        }
        
        .star-clear {
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--danger);
            margin-left: 5px;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        
        .star-clear:hover {
            opacity: 1;
        }
        
        /* Player info link */
        .player-info-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            width: 20px;
            height: 20px;
            font-size: 1rem;
            color: var(--accent);
            text-decoration: none !important;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
            line-height: 1;
        }
        
        .player-info-link:hover {
            opacity: 1;
            transform: scale(1.15);
            text-decoration: none !important;
        }
        
        /* Player titolarità button */
        .player-titolarita-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-left: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
            background: transparent;
            border: 1px solid var(--info);
            border-radius: 12px;
            color: var(--info);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .player-titolarita-btn:hover {
            opacity: 1;
            background: var(--info);
            color: #fff;
        }
        
        .player-titolarita-btn.loading {
            opacity: 0.5;
            cursor: wait;
            animation: pulse-btn 1s infinite;
        }
        
        @keyframes pulse-btn {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }
        
        /* Titolarità Popup */
        .titolarita-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            min-width: 320px;
            max-width: 450px;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .titolarita-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
        }
        
        .titolarita-popup h3 {
            margin: 0 0 15px 0;
            color: var(--gold);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .titolarita-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        
        .titolarita-popup .close-btn:hover {
            color: var(--text);
        }
        
        .titolarita-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .titolarita-stat {
            background: linear-gradient(135deg, var(--bg-main) 0%, rgba(46, 107, 230, 0.1) 100%);
            padding: 15px 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .titolarita-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }
        
        .titolarita-stat.titolare::before { background: var(--success); }
        .titolarita-stat.subentrante::before { background: var(--warning); }
        .titolarita-stat.info::before { background: var(--info); }
        .titolarita-stat.mixed::before { background: linear-gradient(90deg, var(--success) 0%, var(--warning) 100%); }
        
        .titolarita-stat .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            line-height: 1;
        }
        
        .titolarita-stat .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .titolarita-stat.titolare .value { color: var(--success); }
        .titolarita-stat.subentrante .value { color: var(--warning); }
        .titolarita-stat.info .value { color: var(--info); }
        .titolarita-stat.panchina .value { color: var(--danger); }
        
        .titolarita-trend {
            background: var(--bg-main);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--border);
        }
        
        .titolarita-trend.positive {
            border-color: var(--success);
            background: linear-gradient(135deg, var(--bg-main) 0%, rgba(76, 175, 80, 0.1) 100%);
        }
        
        .titolarita-trend.negative {
            border-color: var(--danger);
            background: linear-gradient(135deg, var(--bg-main) 0%, rgba(239, 83, 80, 0.1) 100%);
        }
        
        .titolarita-trend h4 {
            margin: 0 0 12px 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .trend-indicator.positive { 
            color: var(--success);
            background: rgba(76, 175, 80, 0.15);
        }
        .trend-indicator.negative { 
            color: var(--danger);
            background: rgba(239, 83, 80, 0.15);
        }
        .trend-indicator.stable { 
            color: var(--text-secondary);
        }
        
        .trend-icon {
            font-size: 1.5rem;
            filter: drop-shadow(0 0 4px currentColor);
        }
        
        .trend-reasons {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .trend-reasons div {
            padding: 2px 0;
        }
        
        .recent-games {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .recent-games-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .recent-games-icons {
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 1.2rem;
        }
        
        .recent-games-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-left: 10px;
        }
        
        .titolarita-detail {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            margin-top: 0;
        }
        
        .titolarita-detail-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-bar-item {
            background: rgba(0,0,0,0.3);
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }
        
        .stat-bar-item.titolare { border-left-color: var(--success); }
        .stat-bar-item.subentrante { border-left-color: var(--warning); }
        .stat-bar-item.subentrante-sv { border-left-color: var(--danger); }
        .stat-bar-item.panchina { border-left-color: #666; }
        .stat-bar-item.infortunato { border-left-color: #9c27b0; }
        
        .stat-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .stat-bar-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .stat-bar-value {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--text);
        }
        
        .stat-bar-progress {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }
        
        .stat-bar-item.titolare .stat-bar-fill { background: var(--success); }
        .stat-bar-item.subentrante .stat-bar-fill { background: var(--warning); }
        .stat-bar-item.subentrante-sv .stat-bar-fill { background: var(--danger); }
        .stat-bar-item.panchina .stat-bar-fill { background: #666; }
        .stat-bar-item.infortunato .stat-bar-fill { background: #9c27b0; }
        
        .giornate-strip {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .giornata-dot {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            transition: all 0.2s ease;
            cursor: help;
        }
        
        .giornata-dot:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .giornata-dot.titolare { background: var(--success); }
        .giornata-dot.subentrante { background: var(--warning); color: #000; }
        .giornata-dot.subentrante-sv { 
            background: linear-gradient(135deg, var(--warning) 50%, var(--danger) 50%); 
            color: #000; 
        }
        .giornata-dot.panchina { background: #666; }
        .giornata-dot.infortunato { background: #9c27b0; }
        .giornata-dot.assente { background: #555; }
        .giornata-dot.non-giocata { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        
        /* Riepilogo svincoli */
        .riepilogo-svincoli {
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--warning);
        }
        
        .riepilogo-header {
            padding: 15px 20px;
            background: rgba(253, 203, 110, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .riepilogo-header h3 {
            color: var(--warning);
        }
        
        .riepilogo-content {
            padding: 15px 20px;
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.3s ease-out;
        }
        
        .riepilogo-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }
        
        .riepilogo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .riepilogo-item:last-child {
            border-bottom: none;
        }
        
        .riepilogo-empty {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
        }
        
        /* Riepilogo Acquisti */
        .riepilogo-acquisti {
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--success);
        }
        
        .riepilogo-acquisti .riepilogo-header {
            background: rgba(76, 175, 80, 0.1);
        }
        
        .riepilogo-acquisti .riepilogo-header h3 {
            color: var(--success);
        }
        
        .acquisto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            gap: 10px;
        }
        
        .acquisto-item:last-child {
            border-bottom: none;
        }
        
        .acquisto-info {
            flex: 1;
        }
        
        .acquisto-nome {
            font-weight: bold;
            color: var(--text);
        }
        
        .acquisto-dettagli {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .acquisto-costo {
            font-weight: bold;
            color: var(--success);
            font-size: 1.1rem;
        }
        
        .acquisto-remove {
            background: var(--danger);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .acquisto-remove:hover {
            background: #c0392b;
        }
        
        /* Modal Acquisto */
        .acquisto-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .acquisto-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .acquisto-modal h3 {
            margin: 0 0 5px 0;
            color: var(--accent);
        }
        
        .acquisto-modal .player-name {
            font-size: 1.2rem;
            color: var(--gold);
            margin-bottom: 20px;
        }
        
        .acquisto-modal .form-group {
            margin-bottom: 15px;
        }
        
        .acquisto-modal label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .acquisto-modal select,
        .acquisto-modal input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-main);
            color: var(--text);
            font-size: 1rem;
        }
        
        .acquisto-modal select:focus,
        .acquisto-modal input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .acquisto-modal .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .acquisto-modal .buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .acquisto-modal .btn-confirm {
            background: var(--success);
            color: white;
        }
        
        .acquisto-modal .btn-confirm:hover {
            background: #45a049;
        }
        
        .acquisto-modal .btn-cancel {
            background: var(--bg-main);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .acquisto-modal .btn-cancel:hover {
            background: var(--border);
        }
        
        .acquisto-modal .btn-remove {
            background: var(--danger);
            color: white;
        }
        
        .acquisto-modal .btn-remove:hover {
            background: #c0392b;
        }
        
        /* Btn acquistato nelle tabelle */
        .btn-acquistato {
            background: var(--bg-main);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .btn-acquistato:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .btn-acquistato.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .btn-acquistato.active:hover {
            background: var(--warning);
            border-color: var(--warning);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 0 0 auto;
        }
        
        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-width: 120px;
            height: 38px;
            box-sizing: border-box;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .btn-reset-filters {
            height: 38px;
            padding: 0 12px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        /* Config section */
        .config-section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .config-section h3 {
            margin-bottom: 20px;
            color: var(--gold);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-item label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .config-item input {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .config-item select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }
        
        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .config-help {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        .config-actions {
            margin-top: 25px;
            display: flex;
            gap: 15px;
        }
        
        /* Mercato upload */
        .mercato-instructions {
            background: rgba(108, 92, 231, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .mercato-instructions h4 {
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .mercato-instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .mercato-instructions li {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        
        .mercato-instructions kbd {
            background: var(--bg-main);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid var(--border);
        }
        
        .auto-fetch-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn-auto-fetch {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-auto-fetch:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }
        
        .btn-auto-fetch:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-auto-fetch.loading {
            pointer-events: none;
        }
        
        .btn-auto-fetch .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fetch-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .fetch-status.success {
            color: var(--success);
        }
        
        .fetch-status.error {
            color: var(--danger);
        }
        
        .fetch-cooldown {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .mercato-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mercato-upload-zone:hover {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.05);
        }
        
        .mercato-upload-zone .upload-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }
        
        .nuovo-arrivo-badge {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
            animation: pulse-badge 2s infinite;
        }
        
        .infortunato-badge {
            background: linear-gradient(135deg, #d63031, #e17055);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }
        
        .infortunato-badge::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
            margin-left: 8px;
            background: #2d3436;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: normal;
            width: 250px;
            white-space: normal;
            text-align: left;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.1s, visibility 0.1s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .infortunato-badge:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        tr.infortunato {
            background: rgba(214, 48, 49, 0.1) !important;
        }
        
        tr.infortunato:not(.acquistato) td {
            color: #d63031;
        }
        
        .rilasciato-badge {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: normal;
        }
        
        tr.rilasciato {
            background: rgba(108, 92, 231, 0.1) !important;
        }
        
        /* Giocatori acquistati da altri */
        tr.acquistato {
            opacity: 0.5;
            background: rgba(128, 128, 128, 0.1) !important;
        }
        
        tr.acquistato td {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        
        tr.acquistato td.no-strike {
            text-decoration: none;
        }
        
        .acquistato-badge {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .btn-acquistato {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .btn-acquistato:hover {
            background: var(--bg-hover);
        }
        
        .btn-acquistato.active {
            background: #636e72;
            color: white;
            border-color: #636e72;
        }
        
        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .mercato-preview {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .mercato-preview h4 {
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .mercato-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .mercato-preview-item {
            background: rgba(0, 206, 201, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: var(--secondary);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .stats-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .stats-card h3 {
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .budget-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .table-wrapper {
                font-size: 0.85rem;
            }
            
            .table-wrapper th,
            .table-wrapper td {
                padding: 8px 10px;
            }
        }
        
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 1.8rem;
            }
            
            .upload-zone {
                padding: 40px 20px;
            }
            
            /* Header non sticky su mobile - occupa troppo spazio */
            .header {
                position: relative;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            /* Tabs sticky in cima su mobile */
            .tabs {
                padding: 0 5px;
                gap: 5px;
                flex-wrap: wrap;
                justify-content: center;
                position: sticky;
                top: 0;
                z-index: 99;
                background: var(--bg-secondary);
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            
            .content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-group input,
            .filter-group select {
                width: 100%;
            }
            
            .instructions-list li {
                font-size: 0.85rem;
            }
            
            .config-hint-box {
                flex-direction: column;
                text-align: center;
            }
            
            .btn-config-link {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .legenda-items {
                flex-direction: column;
                gap: 8px;
            }
            
            .budget-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-search-wrapper {
                flex-direction: column;
            }
            
            .quick-search-wrapper input {
                width: 100%;
            }
            
            .quick-search-wrapper button {
                width: 100%;
            }
            
            .info-box {
                flex-direction: column;
                text-align: center;
            }
            
            /* Nascondi tabella su mobile, mostra card */
            .svincolati-table-desktop {
                display: none;
            }
            
            .svincolati-cards-mobile {
                display: block;
            }
            
            /* Card mobile styling */
            .player-card {
                background: var(--bg-card);
                border-radius: 12px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                overflow: hidden;
                transition: all 0.2s ease;
            }
            
            .player-card.preferito {
                border-color: var(--accent);
                background: linear-gradient(135deg, var(--bg-card) 0%, rgba(108, 92, 231, 0.15) 100%);
            }
            
            .player-card.acquistato {
                opacity: 0.6;
                border-color: var(--success);
            }
            
            .player-card.infortunato {
                border-left: 3px solid #9c27b0;
            }
            
            .player-card-header {
                padding: 12px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                background: linear-gradient(90deg, var(--bg-secondary), var(--bg-card));
            }
            
            .player-card-header:active {
                background: var(--bg-secondary);
            }
            
            .player-card-main {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
                min-width: 0;
            }
            
            .player-card-name {
                font-weight: bold;
                font-size: 1rem;
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .player-card-name .badges {
                display: inline-flex;
                gap: 5px;
                margin-left: 8px;
                vertical-align: middle;
            }
            
            .player-card-squadra {
                font-size: 0.8rem;
                color: var(--text-secondary);
                background: var(--bg-secondary);
                padding: 2px 8px;
                border-radius: 4px;
                flex-shrink: 0;
            }
            
            .player-card-stats {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            
            .player-card-stat {
                text-align: center;
                padding: 4px 8px;
                background: var(--bg-secondary);
                border-radius: 6px;
                min-width: 45px;
            }
            
            .player-card-stat .value {
                font-weight: bold;
                font-size: 0.95rem;
                color: var(--accent);
            }
            
            .player-card-stat .label {
                font-size: 0.6rem;
                color: var(--text-secondary);
                text-transform: uppercase;
            }
            
            .player-card-stat.highlight .value {
                color: var(--gold);
            }
            
            .player-card-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            
            .player-card-expand {
                color: var(--text-secondary);
                font-size: 1.2rem;
                transition: transform 0.3s;
                margin-left: 5px;
            }
            
            .player-card.expanded .player-card-expand {
                transform: rotate(180deg);
            }
            
            .player-card-body {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
                background: var(--bg-secondary);
            }
            
            .player-card.expanded .player-card-body {
                max-height: 600px;
            }
            
            .player-card-details {
                padding: 15px;
            }
            
            .player-card-details-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .player-card-detail {
                background: var(--bg-card);
                padding: 10px;
                border-radius: 8px;
                text-align: center;
            }
            
            .player-card-detail .value {
                font-size: 1.1rem;
                font-weight: bold;
                color: var(--text-primary);
            }
            
            .player-card-detail .label {
                font-size: 0.7rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                margin-top: 3px;
            }
            
            .player-card-bottom {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-top: 12px;
                border-top: 1px solid var(--border);
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .player-card-stars {
                display: flex;
                align-items: center;
                gap: 3px;
            }
            
            .player-card-stars .star {
                font-size: 1.4rem;
                padding: 5px;
            }
            
            .player-card-links {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .player-card-links a,
            .player-card-links button {
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.85rem;
            }
            
            .player-card .btn-acquistato {
                padding: 10px 16px;
                font-size: 1rem;
                background: var(--success);
                color: white;
                border: none;
            }
            
            .player-card .btn-acquistato.active {
                background: var(--warning);
                color: #000;
            }
            
            .player-card-info-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-bottom: 12px;
            }
            
            .squadra-table-container {
                overflow-x: auto;
            }
            
            .squadra-table-container table {
                min-width: 500px;
            }
            
            /* Titolarità popup mobile - più compatto */
            .titolarita-popup {
                padding: 15px;
                min-width: auto;
                max-width: 95vw;
                width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .titolarita-popup h3 {
                font-size: 0.95rem;
                margin-bottom: 10px;
            }
            
            .titolarita-stats {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-bottom: 12px;
            }
            
            .titolarita-stat {
                padding: 8px 4px;
                border-radius: 6px;
            }
            
            .titolarita-stat .value {
                font-size: 1.3rem;
            }
            
            .titolarita-stat .label {
                font-size: 0.55rem;
                margin-top: 3px;
            }
            
            .titolarita-trend {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .titolarita-trend h4 {
                font-size: 0.65rem;
                margin-bottom: 8px;
            }
            
            .trend-indicator {
                font-size: 0.85rem;
                padding: 8px;
                gap: 8px;
            }
            
            .trend-icon {
                font-size: 1.2rem;
            }
            
            .trend-reasons {
                font-size: 0.7rem;
                line-height: 1.4;
            }
            
            .recent-games {
                padding: 8px;
                margin-top: 8px;
            }
            
            .recent-games-title {
                font-size: 0.65rem;
                margin-bottom: 6px;
            }
            
            .recent-games-icons {
                font-size: 1rem;
                gap: 4px;
            }
            
            .recent-games-label {
                font-size: 0.6rem;
            }
            
            .titolarita-detail {
                padding: 10px;
            }
            
            .titolarita-detail-title {
                font-size: 0.65rem;
                margin-bottom: 8px;
            }
            
            .stats-breakdown {
                gap: 6px;
                margin-bottom: 10px;
            }
            
            .stat-bar-item {
                padding: 6px 8px;
            }
            
            .stat-bar-label {
                font-size: 0.6rem;
            }
            
            .stat-bar-value {
                font-size: 0.75rem;
            }
            
            .giornate-strip {
                gap: 3px;
                padding: 8px;
                margin-top: 8px;
            }
            
            .giornata-dot {
                width: 18px;
                height: 18px;
                font-size: 0.55rem;
            }
        }

        /* Desktop: mostra tabella, nascondi card */
        @media (min-width: 769px) {
            .svincolati-table-desktop {
                display: block;
            }
            
            .svincolati-cards-mobile {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .tab {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .welcome-logo {
                font-size: 50px;
            }
            
            .welcome-title {
                font-size: 1.4rem;
            }
            
            .welcome-subtitle {
                font-size: 1rem;
            }
            
            .disclaimer {
                font-size: 0.8rem;
            }
            
            /* Card ancora più compatte su schermi piccoli */
            .player-card-header {
                padding: 10px 12px;
            }
            
            .player-card-name {
                font-size: 0.9rem;
            }
            
            .player-card-stat {
                padding: 3px 6px;
                min-width: 40px;
            }
            
            .player-card-stat .value {
                font-size: 0.85rem;
            }
            
            .player-card-stat .label {
                font-size: 0.55rem;
            }
            
            .player-card-details {
                padding: 12px;
            }
            
            .player-card-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .player-card-bottom {
                flex-direction: column;
                align-items: stretch;
            }
            
            .player-card-stars {
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .player-card-links {
                flex-direction: column;
                gap: 8px;
            }
            
            .player-card-links a,
            .player-card-links button {
                width: 100%;
                text-align: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Lightbox Modal -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="" alt="Immagine ingrandita">
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Elaborazione in corso...</div>
    </div>

    <!-- Welcome Page -->
    <div id="welcome-page">
        <div class="welcome-container">
            <div class="welcome-logo">⚽</div>
            <h1 class="welcome-title">Fanta Rescue</h1>
            <p class="welcome-subtitle">Gestisci svincoli e budget della tua lega Fantacalcio</p>
            
            <div class="hero-row">
                <div class="features-box">
                    <ul class="features-list">
                        <li>Vedi rose e budget di tutte le squadre</li>
                        <li>Segna svincoli e calcola rimborsi</li>
                        <li>Esplora svincolati con statistiche</li>
                        <li>Segna preferiti e giocatori già presi</li>
                        <li>Visualizza infortunati e nuovi arrivi</li>
                    </ul>
                    <p class="features-privacy">🔒 Tutto nel browser, nessun dato online.<br><small style="opacity: 0.8;">I dati non si sincronizzano tra dispositivi diversi.</small></p>
                </div>
                
                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="file-input" accept=".xlsx,.xls">
                    <div class="upload-icon">📂</div>
                    <div class="upload-text">Carica il file Excel della tua lega</div>
                    <div class="upload-hint">trascina o clicca</div>
                </div>
            </div>
            
            <div class="error-message" id="error-message"></div>
            
            <div class="instructions-box">
                <h4>📥 Come ottenere il file della tua lega</h4>
                <ol class="instructions-list">
                    <li>
                        Apri il <strong>sito web</strong> <a href="https://leghe.fantacalcio.it/login" target="_blank">leghe.fantacalcio.it</a> (non l'app!) e seleziona la tua <strong>lega</strong> dal menu in alto, poi clicca su <strong>Lista Calciatori</strong>
                        <div class="instruction-screenshot">
                            <img src="screenshots/step1-menu-lega.png" alt="Step 1: Seleziona lega e Lista Calciatori" loading="lazy">
                        </div>
                        <div class="mobile-note">
                            <span class="mobile-note-icon">📱</span>
                            <span class="mobile-note-text">Su <strong>mobile</strong>, tocca l'icona menu (☰) in alto a destra per aprire il menu</span>
                            <img src="screenshots/step1-menu-mobile.jpeg" alt="Menu mobile" class="mobile-note-thumb" onclick="openLightbox(this.src)">
                        </div>
                    </li>
                    <li>
                        Nella pagina Lista Calciatori, assicurati che <strong>"Solo svincolati"</strong> sia <strong>disattivato</strong>, poi clicca sul pulsante <strong>Scarica</strong> (icona in alto a destra) e seleziona <strong>"Lista completa"</strong>
                        <div class="instruction-screenshot">
                            <img src="screenshots/step2-scarica-lista.png" alt="Step 2: Scarica Lista Completa" loading="lazy">
                        </div>
                    </li>
                    <li>
                        Carica il file Excel scaricato qui sopra!
                    </li>
                </ol>
            </div>
            
            <div class="disclaimer">
                <span class="disclaimer-icon">⚠️</span>
                <span>
                    <strong>Nota:</strong> Questo tool è ottimizzato per la modalità <strong>Classic</strong>. 
                    La modalità <strong>Mantra</strong> potrebbe non essere completamente supportata a causa 
                    delle differenze nei ruoli e nelle regole.
                </span>
            </div>
            
            <div class="disclaimer file-naming">
                <span class="disclaimer-icon">📁</span>
                <span>
                    <strong>Nome file:</strong> Per funzionare correttamente, il nome del file deve contenere il nome della lega 
                    dopo l'ultimo underscore (es: <code>lista_calciatori_..._nome-lega.xlsx</code>). 
                    Se scarichi il file direttamente da <a href="https://leghe.fantacalcio.it/login" target="_blank" style="color: var(--accent);">leghe.fantacalcio.it</a> senza rinominarlo, funzionerà automaticamente!
                </span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <header class="header">
            <h1>Fanta Rescue <span id="lega-name-display" style="font-size: 0.7em; color: var(--secondary); font-weight: normal;"></span></h1>
            <div class="header-actions">
                <span class="file-info" id="file-info"></span>
                <button class="btn btn-secondary" onclick="changeFile()">📁 Cambia File</button>
                <button class="btn btn-secondary" onclick="resetAllData()" title="Cancella tutti i dati salvati">🗑️ Reset Dati</button>
            </div>
        </header>
        
        <nav class="tabs" id="tabs">
            <button class="tab active" data-tab="svincoli">🏠 Home</button>
            <button class="tab" data-tab="config">⚙️ Configurazione</button>
            <button class="tab" data-tab="portieri">🧤 Portieri</button>
            <button class="tab" data-tab="difensori">🛡️ Difensori</button>
            <button class="tab" data-tab="centrocampisti">⚽ Centrocampisti</button>
            <button class="tab" data-tab="attaccanti">🎯 Attaccanti</button>
        </nav>
        
        <main class="content">
            <!-- Tab Svincoli -->
            <div class="tab-content active" id="tab-svincoli">
                <div class="config-hint-box" id="config-hint-cta">
                    <span>⚙️</span>
                    <span>Vai nella tab <strong>Configurazione</strong> per impostare budget personalizzati e caricare i nuovi arrivi dal mercato.<br><em style="font-size: 0.85em; opacity: 0.9;">⚠️ Se ci sono stati scambi tra squadre durante la stagione, ricordati di correggere manualmente i budget residui!</em></span>
                    <button class="btn-config-link" onclick="switchToTab('config')">Vai a Configurazione →</button>
                </div>
                
                <div class="info-box privacy-inline">
                    <span class="info-icon">🔒</span>
                    <span>I tuoi dati restano nel browser. Svincoli e preferenze sono salvati localmente e associati alla lega "<strong id="lega-name-inline"></strong>".</span>
                </div>
                
                <div class="legenda-box">
                    <h4>📖 Legenda Simboli</h4>
                    <div class="legenda-items">
                        <span class="legenda-item">⚠️ Fuori Lista (non acquistabile)</span>
                        <span class="legenda-item"><span class="nuovo-arrivo-badge">NEW</span> Nuovo acquisto dal mercato</span>
                        <span class="legenda-item"><span class="infortunato-badge">🏥 INF</span> Giocatore infortunato</span>
                        <span class="legenda-item">🔓 Già svincolato (ricerca rapida)</span>
                        <span class="legenda-item">⭐ Preferenza personale (1-5 stelle)</span>
                        <span class="legenda-item" style="color: var(--success)">✅ Riga verde = giocatore svincolato</span>
                        <span class="legenda-item"><span class="acquistato-badge">→ TeamX (5cr)</span> Acquistato da altra squadra</span>
                    </div>
                </div>
                
                <div class="budget-grid" id="budget-grid"></div>
                
                <div class="quick-search-container">
                    <h3>🔍 Ricerca Rapida Svincolo</h3>
                    <p class="help-text">Cerca un calciatore per nome e clicca il pulsante per svincolarlo/annullare lo svincolo rapidamente.</p>
                    <div class="quick-search-wrapper">
                        <input type="text" id="quick-search" placeholder="Cerca calciatore da svincolare...">
                        <button class="btn btn-primary" id="quick-svincola-btn" onclick="quickSvincola()">⚡ Svincola</button>
                        <div class="autocomplete-list" id="autocomplete-list"></div>
                    </div>
                </div>
                
                <div class="riepilogo-svincoli">
                    <div class="riepilogo-header" onclick="toggleRiepilogo()">
                        <h3>📋 Riepilogo Svincoli (<span id="count-svincoli">0</span>)</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <p class="help-text" style="padding: 0 15px;">Elenco di tutti i calciatori svincolati con il rimborso calcolato secondo le regole configurate.</p>
                    <div class="riepilogo-content" id="riepilogo-content"></div>
                </div>
                
                <div class="riepilogo-acquisti">
                    <div class="riepilogo-header" onclick="toggleRiepilogoAcquisti()">
                        <h3>🛒 Riepilogo Acquisti (<span id="count-acquisti">0</span>)</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <p class="help-text" style="padding: 0 15px;">Elenco di tutti i calciatori acquistati dalle squadre della lega.</p>
                    <div class="riepilogo-content" id="riepilogo-acquisti-content"></div>
                </div>
                
                <div id="squadre-container"></div>
            </div>
            
            <!-- Tab Config -->
            <div class="tab-content" id="tab-config">
                <div class="config-section">
                    <h3>⚙️ Impostazioni Lega</h3>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Budget Iniziale (per squadra)</label>
                            <input type="number" id="config-budget-iniziale" value="500">
                        </div>
                        <div class="config-item">
                            <label>Crediti Aggiuntivi Riparazione</label>
                            <input type="number" id="config-crediti-aggiuntivi" value="50">
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>💸 Regole Rimborso Svincoli</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        Configura come vengono calcolati i rimborsi per i giocatori svincolati.
                    </p>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Rimborso Standard (%)</label>
                            <select id="config-rimborso-percentuale">
                                <option value="50">50% (metà del costo)</option>
                                <option value="100">100% (costo intero)</option>
                                <option value="0">0% (nessun rimborso)</option>
                                <option value="25">25%</option>
                                <option value="75">75%</option>
                            </select>
                            <span class="config-help">Percentuale rimborsata per i giocatori svincolati normalmente</span>
                        </div>
                        <div class="config-item">
                            <label>Rimborso Fuori Lista (%)</label>
                            <select id="config-rimborso-fuorilista">
                                <option value="100">100% (costo intero)</option>
                                <option value="50">50% (metà del costo)</option>
                                <option value="0">0% (nessun rimborso)</option>
                            </select>
                            <span class="config-help">Percentuale rimborsata se il giocatore è fuori lista (⚠️)</span>
                        </div>
                        <div class="config-item">
                            <label>Arrotondamento</label>
                            <select id="config-arrotondamento">
                                <option value="floor">Per difetto (⬇ es: 3.5 → 3)</option>
                                <option value="ceil">Per eccesso (⬆ es: 3.5 → 4)</option>
                                <option value="round">Matematico (↔ es: 3.5 → 4, 3.4 → 3)</option>
                            </select>
                            <span class="config-help">Come arrotondare i crediti quando non sono interi</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>💰 Budget Residuo per Squadra</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                        Calcolato automaticamente come: Budget Iniziale - Costo Rosa.<br>
                        Puoi modificare manualmente se necessario.
                    </p>
                    <button class="btn btn-secondary" onclick="recalcBudgetSquadre()" style="margin-bottom: 15px;">
                        🔄 Ricalcola Budget (usa Budget Iniziale attuale)
                    </button>
                    <div class="config-grid" id="config-squadre-grid"></div>
                </div>
                
                <div class="config-actions">
                    <button class="btn btn-primary" onclick="saveConfig()">💾 Salva Configurazione</button>
                    <button class="btn btn-secondary" onclick="resetConfig()">🔄 Reset Default</button>
                </div>
                
                <div class="config-section" style="margin-top: 30px;">
                    <h3>🏥 Infortunati Serie A <span class="optional-badge">Opzionale</span></h3>
                    <div class="info-box" style="margin-bottom: 15px;">
                        <span class="info-icon">ℹ️</span>
                        <span>
                            <strong>A cosa serve?</strong> Caricando la lista infortunati, i giocatori infortunati 
                            verranno evidenziati con un badge <span class="infortunato-badge" style="font-size: 0.7rem;">🏥 INF</span> 
                            nelle tabelle. Passando sopra al badge vedrai i dettagli dell'infortunio.
                        </span>
                    </div>
                    <div class="auto-fetch-section">
                        <button class="btn-auto-fetch" id="btn-fetch-infortunati" onclick="fetchInfortunatiAuto()">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">Aggiorna automaticamente</span>
                        </button>
                        <button class="btn btn-danger" id="btn-reset-infortunati" onclick="clearInfortunati()" style="display: none;">
                            🗑️ Reset infortunati
                        </button>
                        <span class="fetch-status" id="infortunati-fetch-status"></span>
                        <span class="fetch-cooldown" id="infortunati-cooldown"></span>
                    </div>
                    <details class="mercato-details">
                        <summary>📥 Oppure carica manualmente</summary>
                        <div class="mercato-instructions">
                            <h4>Come fare:</h4>
                            <ol>
                                <li>Vai su <a href="https://www.fantacalcio.it/infortunati-serie-a" target="_blank" style="color: var(--accent);">fantacalcio.it/infortunati-serie-a</a></li>
                                <li>Premi <kbd>Cmd+S</kbd> (Mac) o <kbd>Ctrl+S</kbd> (Windows)</li>
                                <li>Salva come "Pagina web, solo HTML" (.html)</li>
                                <li>Carica il file qui sotto</li>
                            </ol>
                        </div>
                        <div class="mercato-upload-zone" id="infortunati-upload-zone">
                            <input type="file" id="infortunati-file-input" accept=".html,.htm" style="display: none;">
                            <div class="upload-content" onclick="document.getElementById('infortunati-file-input').click()">
                                <span class="upload-icon">📥</span>
                                <span>Clicca per caricare il file HTML degli infortunati</span>
                            </div>
                        </div>
                        <div id="infortunati-status" style="margin-top: 10px;"></div>
                        <div id="infortunati-preview" style="margin-top: 15px;"></div>
                    </details>
                </div>
                
                <div class="config-section" style="margin-top: 30px;">
                    <h3>🆕 Nuovi Arrivi dal Mercato <span class="optional-badge">Opzionale</span></h3>
                    <div class="info-box" style="margin-bottom: 15px;">
                        <span class="info-icon">ℹ️</span>
                        <span>
                            <strong>A cosa serve?</strong> Caricando i trasferimenti di mercato, i giocatori appena acquistati 
                            dalle squadre di Serie A verranno evidenziati con un badge <span class="nuovo-arrivo-badge" style="font-size: 0.7rem;">NEW</span> 
                            nelle tabelle. Questo ti aiuta a identificare rapidamente i nuovi arrivi che potrebbero essere 
                            interessanti per l'asta di riparazione.
                        </span>
                    </div>
                    <div class="auto-fetch-section">
                        <button class="btn-auto-fetch" id="btn-fetch-trasferimenti" onclick="fetchTrasferimentiAuto()">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">Aggiorna automaticamente</span>
                        </button>
                        <button class="btn btn-danger" id="btn-reset-trasferimenti" onclick="clearNuoviArrivi()" style="display: none;">
                            🗑️ Reset trasferimenti
                        </button>
                        <span class="fetch-status" id="trasferimenti-fetch-status"></span>
                        <span class="fetch-cooldown" id="trasferimenti-cooldown"></span>
                    </div>
                    <details class="mercato-details">
                        <summary>📥 Oppure carica manualmente</summary>
                        <div class="mercato-instructions">
                            <h4>Come fare:</h4>
                            <ol>
                                <li>Vai su <a href="https://www.fantacalcio.it/calciomercato/trasferimenti-ufficiali" target="_blank" style="color: var(--accent);">fantacalcio.it/trasferimenti-ufficiali</a></li>
                                <li>Premi <kbd>Cmd+S</kbd> (Mac) o <kbd>Ctrl+S</kbd> (Windows)</li>
                                <li>Salva come "Pagina web, solo HTML" (.html)</li>
                                <li>Carica il file qui sotto</li>
                            </ol>
                        </div>
                        <div class="mercato-upload-zone" id="mercato-upload-zone">
                            <input type="file" id="mercato-file-input" accept=".html,.htm" style="display: none;">
                            <div class="upload-content" onclick="document.getElementById('mercato-file-input').click()">
                                <span class="upload-icon">📥</span>
                                <span>Clicca per caricare il file HTML dei trasferimenti</span>
                            </div>
                        </div>
                        <div id="mercato-status" style="margin-top: 10px;"></div>
                        <div id="mercato-preview" style="margin-top: 15px;"></div>
                    </details>
                </div>
            </div>
            
            <!-- Tab Portieri -->
            <div class="tab-content" id="tab-portieri">
                <h2 style="margin-bottom: 10px;">🧤 Portieri Svincolati</h2>
                <div class="info-box">
                    <span class="info-icon">💡</span>
                    <span><strong>Indice Affidabilità</strong> = PGv × FM. Più alto = giocatore che gioca spesso e performa bene.</span>
                </div>
                <div class="filters" id="filters-portieri"></div>
                <div id="table-portieri"></div>
            </div>
            
            <!-- Tab Difensori -->
            <div class="tab-content" id="tab-difensori">
                <h2 style="margin-bottom: 10px;">🛡️ Difensori Svincolati</h2>
                <div class="info-box">
                    <span class="info-icon">💡</span>
                    <span><strong>Indice Affidabilità</strong> = PGv × FM. Più alto = giocatore che gioca spesso e performa bene.</span>
                </div>
                <div class="filters" id="filters-difensori"></div>
                <div id="table-difensori"></div>
            </div>
            
            <!-- Tab Centrocampisti -->
            <div class="tab-content" id="tab-centrocampisti">
                <h2 style="margin-bottom: 10px;">⚽ Centrocampisti Svincolati</h2>
                <div class="info-box">
                    <span class="info-icon">💡</span>
                    <span><strong>Indice Affidabilità</strong> = PGv × FM. Più alto = giocatore che gioca spesso e performa bene.</span>
                </div>
                <div class="filters" id="filters-centrocampisti"></div>
                <div id="table-centrocampisti"></div>
            </div>
            
            <!-- Tab Attaccanti -->
            <div class="tab-content" id="tab-attaccanti">
                <h2 style="margin-bottom: 10px;">🎯 Attaccanti Svincolati</h2>
                <div class="info-box">
                    <span class="info-icon">💡</span>
                    <span><strong>Indice Affidabilità</strong> = PGv × FM. Più alto = giocatore che gioca spesso e performa bene.</span>
                </div>
                <div class="filters" id="filters-attaccanti"></div>
                <div id="table-attaccanti"></div>
            </div>
            
        </main>
    </div>

    <script>
        // ===== LIGHTBOX =====
        function openLightbox(src) {
            const overlay = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox() {
            const overlay = document.getElementById('lightbox');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Chiudi con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
        
        // ===== GLOBAL STATE =====
        let appData = {
            calciatori: [],
            squadre: {},
            svincolati: { P: [], D: [], C: [], A: [] },
            svincoli: {},  // { nomeCalciatore: true }
            preferenze: {}, // { nomeCalciatore: 1-5 }
            acquistati: {}, // { nomeCalciatore: { nome, id, squadra, costo } } - giocatori acquistati da squadre della lega
            nuoviArrivi: {}, // { squadraSerieA: [nome1, nome2, ...] }
            infortunati: {}, // { nomeCalciatore: { descrizione: '...', dataRientro: '...' } }
            config: {
                budgetIniziale: 500,
                creditiAggiuntivi: 50,
                budgetSquadre: {},
                rimborsoPercentuale: 50,
                rimborsoFuoriLista: 100,
                arrotondamento: 'floor' // 'floor' = difetto, 'ceil' = eccesso, 'round' = matematico
            },
            fileName: ''
        };
        
        const RUOLI_MAP = {
            'P': 'Portieri',
            'D': 'Difensori',
            'C': 'Centrocampisti',
            'A': 'Attaccanti'
        };
        
        // Traccia l'ordinamento corrente per ogni tab
        const currentSort = {
            portieri: { col: 'pgv', dir: 'desc' },
            difensori: { col: 'pgv', dir: 'desc' },
            centrocampisti: { col: 'pgv', dir: 'desc' },
            attaccanti: { col: 'pgv', dir: 'desc' }
        };
        
        // Storage keys are now dynamic based on lega name
        let currentLegaName = null;
        
        function getStorageKey(type) {
            if (!currentLegaName) return null;
            return `asta_riparazione_${currentLegaName}_${type}`;
        }
        
        function extractLegaName(fileName) {
            // Remove extension
            let name = fileName.replace(/\.(xlsx|xls)$/i, '');
            
            // Remove version suffixes like " (2)", " (3)", etc.
            name = name.replace(/\s*\(\d+\)\s*$/, '');
            
            // Extract the last part after the last underscore
            // Examples:
            // lista_calciatori_lista calciatori_classic_uefa-cosa-nostra -> uefa-cosa-nostra
            // lista_calciatori_svincolati_classic_pacciofigo -> pacciofigo
            const parts = name.split('_');
            if (parts.length > 0) {
                return parts[parts.length - 1].trim().toLowerCase();
            }
            return 'default';
        }
        
        // ===== FILE HANDLING =====
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        async function processFile(file) {
            hideError();
            
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showError('Per favore carica un file Excel (.xlsx o .xls)');
                return;
            }
            
            loading.classList.add('active');
            appData.fileName = file.name;
            
            // Extract lega name from file for storage keys
            currentLegaName = extractLegaName(file.name);
            console.log('Lega rilevata:', currentLegaName);
            
            try {
                const data = await readExcelFile(file);
                if (data.length === 0) {
                    throw new Error('Il file è vuoto o non contiene dati validi');
                }
                
                // Validate required columns
                const requiredCols = ['Nome', 'R.', 'Sq.'];
                const missingCols = requiredCols.filter(col => !(col in data[0]));
                if (missingCols.length > 0) {
                    throw new Error(`Colonne mancanti: ${missingCols.join(', ')}`);
                }
                
                processData(data);
                loadSavedState();
                showMainApp();
                
            } catch (error) {
                console.error(error);
                showError(`Errore: ${error.message}`);
            } finally {
                loading.classList.remove('active');
            }
        }
        
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Errore nella lettura del file'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        // ===== DATA PROCESSING =====
        function processData(rawData) {
            // Reset dati specifici della lega PRIMA di caricare i nuovi
            appData.svincoli = {};
            appData.preferenze = {};
            appData.acquistati = {};
            
            appData.calciatori = rawData.map(row => ({
                id: row['#'] || 0,
                nome: row['Nome'] || '',
                squadra: row['Sq.'] || '',
                ruolo: row['R.'] || '',
                pgv: parseFloat(row['PGv']) || 0,
                mv: parseFloat(row['MV']) || 0,
                fm: parseFloat(row['FM']) || 0,
                fvm: parseFloat(row['FVM/1000']) || 0,
                quot: parseFloat(row['QUOT.']) || 0,
                fantaSquadra: row['FantaSquadra'] || null,
                costo: parseFloat(row['Costo']) || 0,
                fuoriLista: row['Fuori lista'] === '*'
            }));
            
            // Organize by FantaSquadra
            appData.squadre = {};
            appData.calciatori.forEach(cal => {
                if (cal.fantaSquadra) {
                    if (!appData.squadre[cal.fantaSquadra]) {
                        appData.squadre[cal.fantaSquadra] = [];
                    }
                    appData.squadre[cal.fantaSquadra].push(cal);
                }
            });
            
            // Calculate costs per squadra
            const costiPerSquadra = {};
            Object.keys(appData.squadre).forEach(sq => {
                costiPerSquadra[sq] = appData.squadre[sq].reduce((sum, cal) => sum + cal.costo, 0);
            });
            
            // Initialize config with calculated budgets
            Object.keys(appData.squadre).forEach(sq => {
                appData.config.budgetSquadre[sq] = appData.config.budgetIniziale - costiPerSquadra[sq];
            });
            
            // Build initial svincolati list
            rebuildSvincolati();
        }
        
        // Rebuild svincolati list including players released by fantasy teams
        function rebuildSvincolati() {
            appData.svincolati = { P: [], D: [], C: [], A: [] };
            
            // Track which players are already added (to avoid duplicates)
            const addedPlayers = new Set();
            
            // 1. Add players without fantaSquadra (original svincolati)
            appData.calciatori.forEach(cal => {
                if (!cal.fantaSquadra && !cal.fuoriLista && cal.ruolo) {
                    const indiceAffidabilita = (cal.pgv * cal.fm).toFixed(2);
                    appData.svincolati[cal.ruolo]?.push({
                        ...cal,
                        indiceAffidabilita: parseFloat(indiceAffidabilita),
                        rilasciatoDa: null
                    });
                    addedPlayers.add(cal.nome);
                }
            });
            
            // 2. Add players released by fantasy teams (svincolati)
            Object.keys(appData.squadre).forEach(sq => {
                appData.squadre[sq].forEach(cal => {
                    // If player is svincolato and not fuoriLista, add to available pool
                    if (appData.svincoli[cal.nome] && !cal.fuoriLista && !addedPlayers.has(cal.nome)) {
                        const indiceAffidabilita = (cal.pgv * cal.fm).toFixed(2);
                        appData.svincolati[cal.ruolo]?.push({
                            ...cal,
                            indiceAffidabilita: parseFloat(indiceAffidabilita),
                            rilasciatoDa: sq  // Track which team released them
                        });
                        addedPlayers.add(cal.nome);
                    }
                });
            });
            
            // Sort by PGv
            Object.keys(appData.svincolati).forEach(ruolo => {
                appData.svincolati[ruolo].sort((a, b) => b.pgv - a.pgv);
            });
        }
        
        // ===== PERSISTENCE =====
        function loadSavedState() {
            if (!currentLegaName) return;
            
            // Load svincoli
            const keyS = getStorageKey('svincoli');
            const savedSvincoli = keyS ? localStorage.getItem(keyS) : null;
            if (savedSvincoli) {
                try {
                    appData.svincoli = JSON.parse(savedSvincoli);
                    console.log(`Caricati ${Object.keys(appData.svincoli).length} svincoli per lega "${currentLegaName}"`);
                } catch (e) {
                    appData.svincoli = {};
                }
            }
            
            // Load config
            const keyC = getStorageKey('config');
            const savedConfig = keyC ? localStorage.getItem(keyC) : null;
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    appData.config.budgetIniziale = parsed.budgetIniziale ?? 500;
                    appData.config.creditiAggiuntivi = parsed.creditiAggiuntivi ?? 50;
                    appData.config.rimborsoPercentuale = parsed.rimborsoPercentuale ?? 50;
                    appData.config.rimborsoFuoriLista = parsed.rimborsoFuoriLista ?? 100;
                    appData.config.arrotondamento = parsed.arrotondamento || 'floor';
                    if (parsed.budgetSquadre) {
                        Object.keys(parsed.budgetSquadre).forEach(sq => {
                            if (sq in appData.config.budgetSquadre) {
                                appData.config.budgetSquadre[sq] = parsed.budgetSquadre[sq];
                            }
                        });
                    }
                    // Nascondo la CTA config se esiste già una configurazione salvata
                    const configHintCta = document.getElementById('config-hint-cta');
                    if (configHintCta) configHintCta.style.display = 'none';
                } catch (e) {
                    console.error('Error loading config:', e);
                }
            }
            
            // Load preferenze
            const keyP = getStorageKey('preferenze');
            const savedPreferenze = keyP ? localStorage.getItem(keyP) : null;
            if (savedPreferenze) {
                try {
                    appData.preferenze = JSON.parse(savedPreferenze);
                } catch (e) {
                    appData.preferenze = {};
                }
            }
            
            // Load nuovi arrivi (GLOBALE - non dipende dalla lega)
            const savedNuoviArrivi = localStorage.getItem('asta_riparazione_global_nuoviarrivi');
            if (savedNuoviArrivi) {
                try {
                    appData.nuoviArrivi = JSON.parse(savedNuoviArrivi);
                    console.log(`Caricati nuovi arrivi per ${Object.keys(appData.nuoviArrivi).length} squadre`);
                } catch (e) {
                    appData.nuoviArrivi = {};
                }
            }
            
            // Load acquistati (giocatori presi da altri)
            const keyAcq = getStorageKey('acquistati');
            const savedAcquistati = keyAcq ? localStorage.getItem(keyAcq) : null;
            if (savedAcquistati) {
                try {
                    const parsed = JSON.parse(savedAcquistati);
                    // Migrazione: se i dati sono nel vecchio formato { nome: true }, convertili
                    const migrated = {};
                    Object.entries(parsed).forEach(([nome, value]) => {
                        if (value === true) {
                            // Vecchio formato - converti con valori di default
                            migrated[nome] = { nome, squadra: 'Sconosciuta', costo: 0, id: 0 };
                        } else if (value && typeof value === 'object') {
                            // Nuovo formato
                            migrated[nome] = value;
                        }
                    });
                    appData.acquistati = migrated;
                    console.log(`Caricati ${Object.keys(appData.acquistati).length} giocatori acquistati da altri`);
                } catch (e) {
                    appData.acquistati = {};
                }
            }
            
            // Load infortunati (GLOBALE - non dipende dalla lega)
            const savedInfortunati = localStorage.getItem('asta_riparazione_global_infortunati');
            if (savedInfortunati) {
                try {
                    appData.infortunati = JSON.parse(savedInfortunati);
                    console.log(`Caricati ${Object.keys(appData.infortunati).length} giocatori infortunati`);
                } catch (e) {
                    appData.infortunati = {};
                }
            }
            
            // Rebuild svincolati to include released players
            if (Object.keys(appData.svincoli).length > 0) {
                rebuildSvincolati();
                updateRiepilogoSvincoli();
            }
        }
        
        function saveSvincoli() {
            const key = getStorageKey('svincoli');
            if (key) localStorage.setItem(key, JSON.stringify(appData.svincoli));
        }
        
        function savePreferenze() {
            const key = getStorageKey('preferenze');
            if (key) localStorage.setItem(key, JSON.stringify(appData.preferenze));
        }
        
        function saveNuoviArrivi() {
            // Chiave globale - i trasferimenti sono uguali per tutte le leghe
            const key = 'asta_riparazione_global_nuoviarrivi';
            localStorage.setItem(key, JSON.stringify(appData.nuoviArrivi));
        }
        
        function saveConfig() {
            // Read values from inputs - use nullish coalescing to allow 0 values
            const budgetInizialeVal = parseInt(document.getElementById('config-budget-iniziale').value);
            appData.config.budgetIniziale = isNaN(budgetInizialeVal) ? 500 : budgetInizialeVal;
            
            const creditiAggVal = parseInt(document.getElementById('config-crediti-aggiuntivi').value);
            appData.config.creditiAggiuntivi = isNaN(creditiAggVal) ? 50 : creditiAggVal;
            
            // Read rimborso options
            appData.config.rimborsoPercentuale = parseInt(document.getElementById('config-rimborso-percentuale').value) || 50;
            appData.config.rimborsoFuoriLista = parseInt(document.getElementById('config-rimborso-fuorilista').value) || 100;
            appData.config.arrotondamento = document.getElementById('config-arrotondamento').value || 'floor';
            
            // Read per-squadra budgets - allow 0 and negative values
            Object.keys(appData.squadre).forEach(sq => {
                const input = document.getElementById(`config-budget-${sq.replace(/[^a-zA-Z0-9]/g, '_')}`);
                if (input) {
                    const val = parseInt(input.value);
                    appData.config.budgetSquadre[sq] = isNaN(val) ? 0 : val;
                }
            });
            
            const keyConfig = getStorageKey('config');
            if (keyConfig) localStorage.setItem(keyConfig, JSON.stringify(appData.config));
            
            // Refresh UI - ricalcola tutti i rimborsi con le nuove regole
            renderBudgetCards();
            renderSquadre();
            updateTotaleLega();
            updateRiepilogoSvincoli();
            alert('✅ Configurazione salvata!');
        }
        
        function resetConfig() {
            if (!confirm('Sei sicuro di voler resettare la configurazione ai valori di default?')) return;
            
            appData.config.budgetIniziale = 500;
            appData.config.creditiAggiuntivi = 50;
            appData.config.rimborsoPercentuale = 50;
            appData.config.rimborsoFuoriLista = 100;
            appData.config.arrotondamento = 'floor';
            
            // Recalculate budgets
            Object.keys(appData.squadre).forEach(sq => {
                const costo = appData.squadre[sq].reduce((sum, cal) => sum + cal.costo, 0);
                appData.config.budgetSquadre[sq] = appData.config.budgetIniziale - costo;
            });
            
            const keyConfig = getStorageKey('config');
            if (keyConfig) localStorage.removeItem(keyConfig);
            
            renderConfigPage();
            renderBudgetCards();
            renderSquadre();
            updateTotaleLega();
            updateRiepilogoSvincoli();
            alert('🔄 Configurazione resettata!');
        }
        
        function recalcBudgetSquadre() {
            // Leggi il budget iniziale dal campo input (non da appData, per usare il valore attuale)
            const budgetIniziale = parseInt(document.getElementById('config-budget-iniziale').value) || 500;
            
            // Ricalcola i budget per ogni squadra
            Object.keys(appData.squadre).forEach(sq => {
                const costo = appData.squadre[sq].reduce((sum, cal) => sum + cal.costo, 0);
                appData.config.budgetSquadre[sq] = budgetIniziale - costo;
            });
            
            // Aggiorna la griglia nella pagina config
            const grid = document.getElementById('config-squadre-grid');
            grid.innerHTML = Object.keys(appData.squadre).sort().map(sq => {
                const safeId = sq.replace(/[^a-zA-Z0-9]/g, '_');
                const budget = appData.config.budgetSquadre[sq] || 0;
                return `
                    <div class="config-item">
                        <label>${sq}</label>
                        <input type="number" id="config-budget-${safeId}" value="${budget}">
                    </div>
                `;
            }).join('');
            
            alert(`✅ Budget ricalcolati con Budget Iniziale = ${budgetIniziale}`);
        }
        
        function resetAllData() {
            if (!confirm(`⚠️ Vuoi cancellare i dati salvati per la lega "${currentLegaName}"?\n\nQuesto include:\n- Svincoli selezionati\n- Configurazione budget\n- Preferenze giocatori\n- Giocatori segnati come acquistati\n\n⚠️ Infortunati e trasferimenti NON verranno cancellati (sono dati globali).\n\nL'operazione non può essere annullata.`)) return;
            
            const keyS = getStorageKey('svincoli');
            const keyC = getStorageKey('config');
            const keyP = getStorageKey('preferenze');
            const keyAcq = getStorageKey('acquistati');
            if (keyS) localStorage.removeItem(keyS);
            if (keyC) localStorage.removeItem(keyC);
            if (keyP) localStorage.removeItem(keyP);
            if (keyAcq) localStorage.removeItem(keyAcq);
            // NON rimuovere nuoviarrivi e infortunati - sono globali
            
            appData.svincoli = {};
            appData.preferenze = {};
            appData.acquistati = {};
            // NON resettare nuoviArrivi e infortunati - sono globali
            
            // Reset config to defaults
            appData.config.budgetIniziale = 500;
            appData.config.creditiAggiuntivi = 50;
            Object.keys(appData.squadre).forEach(sq => {
                const costo = appData.squadre[sq].reduce((sum, cal) => sum + cal.costo, 0);
                appData.config.budgetSquadre[sq] = appData.config.budgetIniziale - costo;
            });
            
            renderAll();
            updateMercatoPreview();
            updateInfortunatiPreview();
            alert('🗑️ Dati della lega cancellati! (Infortunati e trasferimenti sono globali e non vengono cancellati)');
        }
        
        // ===== INFORTUNATI =====
        function setupInfortunatiUpload() {
            const infortunatiInput = document.getElementById('infortunati-file-input');
            if (infortunatiInput) {
                infortunatiInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) processInfortunatiFile(file);
                });
            }
        }
        
        async function processInfortunatiFile(file) {
            const statusDiv = document.getElementById('infortunati-status');
            statusDiv.innerHTML = '<span style="color: var(--accent);">⏳ Elaborazione in corso...</span>';
            
            try {
                const htmlContent = await file.text();
                const infortunati = parseInfortunatiHTML(htmlContent);
                
                if (Object.keys(infortunati).length === 0) {
                    statusDiv.innerHTML = '<span style="color: var(--warning);">⚠️ Nessun infortunato trovato nel file. Assicurati di aver salvato la pagina corretta.</span>';
                    return;
                }
                
                appData.infortunati = infortunati;
                saveInfortunati();
                
                const totalInfortunati = Object.keys(infortunati).length;
                statusDiv.innerHTML = `<span style="color: var(--success);">✅ Caricati ${totalInfortunati} giocatori infortunati!</span>`;
                
                updateInfortunatiPreview();
                
                // Re-render tables to show badges
                renderSquadre(true);
                renderSvincolatiTables();
                
            } catch (error) {
                console.error('Error processing infortunati file:', error);
                statusDiv.innerHTML = `<span style="color: var(--danger);">❌ Errore: ${error.message}</span>`;
            }
        }
        
        function parseInfortunatiHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const infortunati = {};
            
            // Struttura HTML di fantacalcio.it/infortunati-serie-a:
            // <div class="card team-card">
            //   <header class="team-info">
            //     <span class="team-name">Nome Squadra</span>
            //   </header>
            //   <ul class="unstyled">
            //     <li>
            //       <strong class="item-name">Nome Giocatore</strong>
            //       <div class="item-description"><p>Descrizione infortunio...</p></div>
            //     </li>
            //   </ul>
            // </div>
            
            const teamCards = doc.querySelectorAll('.team-card');
            
            teamCards.forEach(card => {
                const teamNameEl = card.querySelector('.team-name');
                if (!teamNameEl) return;
                
                const squadraNome = teamNameEl.textContent.trim();
                
                // Trova tutti i giocatori infortunati
                const items = card.querySelectorAll('li');
                
                items.forEach(item => {
                    const nameEl = item.querySelector('.item-name, strong');
                    const descEl = item.querySelector('.item-description p, .item-description');
                    
                    if (nameEl) {
                        const nome = nameEl.textContent.trim();
                        const descrizione = descEl ? descEl.textContent.trim() : 'Infortunato';
                        
                        if (nome && nome.length > 1) {
                            infortunati[nome] = {
                                squadra: squadraNome,
                                descrizione: descrizione
                            };
                        }
                    }
                });
            });
            
            return infortunati;
        }
        
        function isInfortunato(nomeCalciatore) {
            if (!appData.infortunati || Object.keys(appData.infortunati).length === 0) return null;
            
            // Normalizza il nome per il confronto
            const nomeNorm = nomeCalciatore.toLowerCase().trim();
            
            for (const [nomeInf, info] of Object.entries(appData.infortunati)) {
                const nomeInfNorm = nomeInf.toLowerCase().trim();
                
                // Match ESATTO (case insensitive)
                if (nomeNorm === nomeInfNorm) {
                    return info;
                }
                
                // Match per cognome esatto (il nome nel file Excel potrebbe essere solo il cognome)
                // Es: "Vlahovic" nel file Excel vs "Dusan Vlahovic" negli infortunati
                const partsNome = nomeNorm.split(' ');
                const partsInf = nomeInfNorm.split(' ');
                
                // Se il nome nel file è una sola parola (cognome), cerca match esatto con una delle parti dell'infortunato
                if (partsNome.length === 1 && partsInf.some(part => part === nomeNorm)) {
                    return info;
                }
                
                // Se l'infortunato ha una sola parola (cognome), cerca match esatto con una delle parti del nome file
                if (partsInf.length === 1 && partsNome.some(part => part === nomeInfNorm)) {
                    return info;
                }
            }
            return null;
        }
        
        function updateInfortunatiPreview() {
            const previewDiv = document.getElementById('infortunati-preview');
            const resetBtn = document.getElementById('btn-reset-infortunati');
            if (!previewDiv) return;
            
            const hasInfortunati = Object.keys(appData.infortunati).length > 0;
            
            // Mostra/nascondi pulsante reset
            if (resetBtn) {
                resetBtn.style.display = hasInfortunati ? 'inline-block' : 'none';
            }
            
            if (!hasInfortunati) {
                previewDiv.innerHTML = '';
                return;
            }
            
            let html = '<div class="mercato-preview">';
            html += '<h4>🏥 Infortunati Caricati (' + Object.keys(appData.infortunati).length + ')</h4>';
            
            // Raggruppa per squadra
            const perSquadra = {};
            Object.entries(appData.infortunati).forEach(([nome, info]) => {
                const sq = info.squadra || 'Altro';
                if (!perSquadra[sq]) perSquadra[sq] = [];
                perSquadra[sq].push({ nome, descrizione: info.descrizione });
            });
            
            Object.keys(perSquadra).sort().forEach(squadra => {
                const giocatori = perSquadra[squadra];
                html += `<div style="margin-bottom: 10px;"><strong>${squadra}:</strong> `;
                html += '<div class="mercato-preview-list">';
                giocatori.forEach(g => {
                    html += `<span class="mercato-preview-item" title="${g.descrizione}" style="cursor: help;">🏥 ${g.nome}</span>`;
                });
                html += '</div></div>';
            });
            
            html += '</div>';
            
            previewDiv.innerHTML = html;
        }
        
        function clearInfortunati() {
            if (!confirm('Vuoi rimuovere i dati sugli infortunati? (Questo vale per tutte le leghe)')) return;
            
            appData.infortunati = {};
            localStorage.removeItem('asta_riparazione_global_infortunati');
            
            updateInfortunatiPreview();
            renderSquadre(true);
            renderSvincolatiTables();
            
            document.getElementById('infortunati-status').innerHTML = '';
        }
        
        function saveInfortunati() {
            // Chiave globale - gli infortunati sono uguali per tutte le leghe
            const key = 'asta_riparazione_global_infortunati';
            localStorage.setItem(key, JSON.stringify(appData.infortunati));
        }
        
        // ===== AUTO FETCH VIA PROXY =====
        const PROXY_URL = 'https://api.codetabs.com/v1/proxy/?quest=';
        const FETCH_COOLDOWN_MS = 10 * 60 * 1000; // 10 minuti
        
        function getLastFetchTime(type) {
            const key = `asta_riparazione_lastfetch_${type}`;
            const val = localStorage.getItem(key);
            return val ? parseInt(val) : 0;
        }
        
        function setLastFetchTime(type) {
            const key = `asta_riparazione_lastfetch_${type}`;
            localStorage.setItem(key, Date.now().toString());
        }
        
        function canFetch(type) {
            const lastFetch = getLastFetchTime(type);
            const now = Date.now();
            return (now - lastFetch) >= FETCH_COOLDOWN_MS;
        }
        
        function getRemainingCooldown(type) {
            const lastFetch = getLastFetchTime(type);
            const now = Date.now();
            const elapsed = now - lastFetch;
            const remaining = FETCH_COOLDOWN_MS - elapsed;
            if (remaining <= 0) return null;
            const minutes = Math.ceil(remaining / 60000);
            return `Disponibile tra ${minutes} min`;
        }
        
        function updateCooldownDisplay(type) {
            const cooldownEl = document.getElementById(`${type}-cooldown`);
            const btnEl = document.getElementById(`btn-fetch-${type}`);
            if (!cooldownEl || !btnEl) return;
            
            const remaining = getRemainingCooldown(type);
            if (remaining) {
                cooldownEl.textContent = remaining;
                btnEl.disabled = true;
            } else {
                cooldownEl.textContent = '';
                btnEl.disabled = false;
            }
        }
        
        function setFetchLoading(type, loading) {
            const btnEl = document.getElementById(`btn-fetch-${type}`);
            if (!btnEl) return;
            
            const iconEl = btnEl.querySelector('.btn-icon');
            const textEl = btnEl.querySelector('.btn-text');
            
            if (loading) {
                btnEl.classList.add('loading');
                btnEl.disabled = true;
                iconEl.innerHTML = '<div class="spinner"></div>';
                textEl.textContent = 'Caricamento...';
            } else {
                btnEl.classList.remove('loading');
                iconEl.textContent = '🔄';
                textEl.textContent = 'Aggiorna automaticamente';
                updateCooldownDisplay(type);
            }
        }
        
        function setFetchStatus(type, message, isError = false) {
            const statusEl = document.getElementById(`${type}-fetch-status`);
            if (!statusEl) return;
            
            statusEl.textContent = message;
            statusEl.className = 'fetch-status ' + (isError ? 'error' : 'success');
            
            // Rimuovi il messaggio dopo 5 secondi
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = 'fetch-status';
            }, 5000);
        }
        
        async function fetchInfortunatiAuto() {
            if (!canFetch('infortunati')) {
                setFetchStatus('infortunati', getRemainingCooldown('infortunati'), true);
                return;
            }
            
            setFetchLoading('infortunati', true);
            
            try {
                const url = PROXY_URL + encodeURIComponent('https://www.fantacalcio.it/infortunati-serie-a');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const html = await response.text();
                
                // Verifica che sia una pagina valida
                if (!html.includes('team-card')) {
                    throw new Error('Contenuto non valido');
                }
                
                // Parsa e salva
                const infortunati = parseInfortunatiHTML(html);
                const count = Object.keys(infortunati).length;
                
                if (count === 0) {
                    throw new Error('Nessun infortunato trovato');
                }
                
                appData.infortunati = infortunati;
                saveInfortunati();
                setLastFetchTime('infortunati');
                
                // Aggiorna UI
                updateInfortunatiPreview();
                renderSquadre(true);
                renderSvincolatiTables();
                
                setFetchStatus('infortunati', `✅ Caricati ${count} infortunati`);
                
            } catch (error) {
                console.error('Fetch infortunati error:', error);
                setFetchStatus('infortunati', '❌ Errore, usa caricamento manuale', true);
            } finally {
                setFetchLoading('infortunati', false);
            }
        }
        
        async function fetchTrasferimentiAuto() {
            if (!canFetch('trasferimenti')) {
                setFetchStatus('trasferimenti', getRemainingCooldown('trasferimenti'), true);
                return;
            }
            
            setFetchLoading('trasferimenti', true);
            
            try {
                const url = PROXY_URL + encodeURIComponent('https://www.fantacalcio.it/calciomercato/trasferimenti-ufficiali');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const html = await response.text();
                
                // Verifica che sia una pagina valida (cerca classi tipiche)
                if (!html.includes('player-info') && !html.includes('transfer')) {
                    throw new Error('Contenuto non valido');
                }
                
                // Parsa e salva
                const nuoviArrivi = parseTrasferimentiHTML(html);
                const squadreCount = Object.keys(nuoviArrivi).length;
                const playerCount = Object.values(nuoviArrivi).flat().length;
                
                if (playerCount === 0) {
                    throw new Error('Nessun trasferimento trovato');
                }
                
                appData.nuoviArrivi = nuoviArrivi;
                saveNuoviArrivi();
                setLastFetchTime('trasferimenti');
                
                // Aggiorna UI
                updateMercatoPreview();
                renderSquadre(true);
                renderSvincolatiTables();
                
                setFetchStatus('trasferimenti', `✅ Caricati ${playerCount} trasferimenti in ${squadreCount} squadre`);
                
            } catch (error) {
                console.error('Fetch trasferimenti error:', error);
                setFetchStatus('trasferimenti', '❌ Errore, usa caricamento manuale', true);
            } finally {
                setFetchLoading('trasferimenti', false);
            }
        }
        
        function initAutoFetchUI() {
            updateCooldownDisplay('infortunati');
            updateCooldownDisplay('trasferimenti');
            
            // Aggiorna cooldown ogni minuto
            setInterval(() => {
                updateCooldownDisplay('infortunati');
                updateCooldownDisplay('trasferimenti');
            }, 60000);
        }

        // ===== MERCATO / NUOVI ARRIVI =====
        function setupMercatoUpload() {
            const mercatoInput = document.getElementById('mercato-file-input');
            if (mercatoInput) {
                mercatoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) processMercatoFile(file);
                });
            }
        }
        
        async function processMercatoFile(file) {
            const statusDiv = document.getElementById('mercato-status');
            statusDiv.innerHTML = '<span style="color: var(--accent);">⏳ Elaborazione in corso...</span>';
            
            try {
                const htmlContent = await file.text();
                const nuoviArrivi = parseTrasferimentiHTML(htmlContent);
                
                if (Object.keys(nuoviArrivi).length === 0) {
                    statusDiv.innerHTML = '<span style="color: var(--warning);">⚠️ Nessun trasferimento trovato nel file. Assicurati di aver salvato la pagina corretta.</span>';
                    return;
                }
                
                appData.nuoviArrivi = nuoviArrivi;
                saveNuoviArrivi();
                
                const totalArrivi = Object.values(nuoviArrivi).reduce((sum, arr) => sum + arr.length, 0);
                statusDiv.innerHTML = `<span style="color: var(--success);">✅ Caricati ${totalArrivi} nuovi arrivi da ${Object.keys(nuoviArrivi).length} squadre!</span>`;
                
                updateMercatoPreview();
                
                // Re-render tables to show badges
                renderSquadre(true);
                renderSvincolatiTables();
                
            } catch (error) {
                console.error('Error processing mercato file:', error);
                statusDiv.innerHTML = `<span style="color: var(--danger);">❌ Errore: ${error.message}</span>`;
            }
        }
        
        function parseTrasferimentiHTML(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const nuoviArrivi = {};
            
            // La struttura HTML di fantacalcio.it è:
            // <div class="card team-card" id="roma">
            //   <header> ... <a class="team-name">Roma</a> ... </header>
            //   <div class="card-content">
            //     <div class="joined">  <-- ARRIVI
            //       <ul class="transfers">
            //         <li class="transfer">
            //           <span class="name" itemprop="name">NomeGiocatore</span>
            //         </li>
            //       </ul>
            //     </div>
            //     <div class="left">  <-- PARTENZE
            //       ...
            //     </div>
            //   </div>
            // </div>
            
            // Trova tutte le card delle squadre
            const teamCards = doc.querySelectorAll('.team-card');
            
            teamCards.forEach(card => {
                // Trova il nome della squadra
                const teamNameEl = card.querySelector('.team-name');
                if (!teamNameEl) return;
                
                const squadraNome = teamNameEl.textContent.trim();
                if (!squadraNome) return;
                
                // Trova la sezione "joined" (arrivi)
                const joinedSection = card.querySelector('.joined');
                if (!joinedSection) return;
                
                // Trova tutti i trasferimenti in arrivo
                const transfers = joinedSection.querySelectorAll('.transfer');
                const arrivi = [];
                
                transfers.forEach(transfer => {
                    // Il nome del giocatore è nel primo span.name dentro header
                    const headerDiv = transfer.querySelector('.header');
                    if (headerDiv) {
                        const nameSpan = headerDiv.querySelector('span.name[itemprop="name"]');
                        if (nameSpan) {
                            const nome = nameSpan.textContent.trim();
                            if (nome && nome.length > 1) {
                                arrivi.push(nome);
                            }
                        }
                    }
                });
                
                if (arrivi.length > 0) {
                    nuoviArrivi[squadraNome] = arrivi;
                }
            });
            
            return nuoviArrivi;
        }
        
        function isNuovoArrivo(nomeCalciatore, squadraSerieA) {
            if (!squadraSerieA || !appData.nuoviArrivi) return false;
            
            const arriviSquadra = appData.nuoviArrivi[squadraSerieA];
            if (!arriviSquadra) return false;
            
            // Normalizza il nome per il confronto
            const nomeNorm = nomeCalciatore.toLowerCase().trim();
            
            return arriviSquadra.some(arrivo => {
                const arrivoNorm = arrivo.toLowerCase().trim();
                // Match esatto o parziale (il cognome)
                return nomeNorm.includes(arrivoNorm) || arrivoNorm.includes(nomeNorm) ||
                       nomeNorm.split(' ').some(part => arrivoNorm.includes(part) && part.length > 3);
            });
        }
        
        function updateMercatoPreview() {
            const previewDiv = document.getElementById('mercato-preview');
            const resetBtn = document.getElementById('btn-reset-trasferimenti');
            if (!previewDiv) return;
            
            const hasNuoviArrivi = Object.keys(appData.nuoviArrivi).length > 0;
            const totalePlayers = Object.values(appData.nuoviArrivi).flat().length;
            
            // Mostra/nascondi pulsante reset
            if (resetBtn) {
                resetBtn.style.display = hasNuoviArrivi ? 'inline-block' : 'none';
            }
            
            if (!hasNuoviArrivi) {
                previewDiv.innerHTML = '';
                return;
            }
            
            let html = '<div class="mercato-preview">';
            html += '<h4>🆕 Nuovi Arrivi Caricati (' + totalePlayers + ')</h4>';
            
            Object.keys(appData.nuoviArrivi).sort().forEach(squadra => {
                const arrivi = appData.nuoviArrivi[squadra];
                if (arrivi.length > 0) {
                    html += `<div style="margin-bottom: 10px;"><strong>${squadra}:</strong> `;
                    html += '<div class="mercato-preview-list">';
                    arrivi.forEach(nome => {
                        html += `<span class="mercato-preview-item">${nome}</span>`;
                    });
                    html += '</div></div>';
                }
            });
            
            html += '</div>';
            
            previewDiv.innerHTML = html;
        }
        
        function clearNuoviArrivi() {
            if (!confirm('Vuoi rimuovere i dati sui nuovi arrivi? (Questo vale per tutte le leghe)')) return;
            
            appData.nuoviArrivi = {};
            localStorage.removeItem('asta_riparazione_global_nuoviarrivi');
            
            updateMercatoPreview();
            renderSquadre(true);
            renderSvincolatiTables();
            
            document.getElementById('mercato-status').innerHTML = '';
        }

        // ===== UI RENDERING =====
        function showMainApp() {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-app').classList.add('active');
            document.getElementById('file-info').textContent = `📄 ${appData.fileName}`;
            document.getElementById('lega-name-display').textContent = `• ${currentLegaName}`;
            
            // Update lega name in info box
            const legaNameInline = document.getElementById('lega-name-inline');
            if (legaNameInline) legaNameInline.textContent = currentLegaName;
            
            renderAll();
        }
        
        function changeFile() {
            document.getElementById('main-app').classList.remove('active');
            document.getElementById('welcome-page').style.display = 'flex';
            fileInput.value = '';
        }
        
        function renderAll() {
            renderConfigPage();
            renderBudgetCards();
            renderSquadre();
            renderSvincolatiTables();
            updateTotaleLega();
            updateRiepilogoSvincoli();
            updateRiepilogoAcquisti();
            setupQuickSearch();
            setupMercatoUpload();
            setupInfortunatiUpload();
            updateMercatoPreview();
            updateInfortunatiPreview();
            initAutoFetchUI();
        }
        
        function renderConfigPage() {
            document.getElementById('config-budget-iniziale').value = appData.config.budgetIniziale;
            document.getElementById('config-crediti-aggiuntivi').value = appData.config.creditiAggiuntivi;
            
            // Rimborso options
            document.getElementById('config-rimborso-percentuale').value = appData.config.rimborsoPercentuale;
            document.getElementById('config-rimborso-fuorilista').value = appData.config.rimborsoFuoriLista;
            document.getElementById('config-arrotondamento').value = appData.config.arrotondamento;
            
            const grid = document.getElementById('config-squadre-grid');
            grid.innerHTML = Object.keys(appData.squadre).sort().map(sq => {
                const safeId = sq.replace(/[^a-zA-Z0-9]/g, '_');
                const budget = appData.config.budgetSquadre[sq] || 0;
                return `
                    <div class="config-item">
                        <label>${sq}</label>
                        <input type="number" id="config-budget-${safeId}" value="${budget}">
                    </div>
                `;
            }).join('');
        }
        
        function renderBudgetCards() {
            const grid = document.getElementById('budget-grid');
            if (!grid) return;
            grid.innerHTML = Object.keys(appData.squadre).sort().map(sq => {
                const budgetBase = appData.config.budgetSquadre[sq] || 0;
                const creditiAgg = appData.config.creditiAggiuntivi;
                const creditiRecuperati = calcCreditiRecuperatiSquadra(sq);
                const creditiSpesi = calcCreditiSpesiSquadra(sq);
                const totale = budgetBase + creditiAgg + creditiRecuperati - creditiSpesi;
                
                return `
                    <div class="budget-card">
                        <h3>${sq}</h3>
                        <div class="budget-row">
                            <span>Budget post asta:</span>
                            <span>${budgetBase}</span>
                        </div>
                        <div class="budget-row">
                            <span>Crediti aggiuntivi:</span>
                            <span>+${creditiAgg}</span>
                        </div>
                        <div class="budget-row" style="color: var(--success)">
                            <span>Crediti recuperati:</span>
                            <span>+${creditiRecuperati}</span>
                        </div>
                        ${creditiSpesi > 0 ? `
                        <div class="budget-row" style="color: var(--danger)">
                            <span>Acquisti riparaz.:</span>
                            <span>-${creditiSpesi}</span>
                        </div>
                        ` : ''}
                        <div class="budget-row total">
                            <span>BUDGET DISPONIBILE:</span>
                            <span class="value">${totale}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function calcCreditiRecuperatiSquadra(squadra) {
            const calciatori = appData.squadre[squadra] || [];
            return calciatori.reduce((sum, cal) => {
                if (appData.svincoli[cal.nome]) {
                    return sum + calcRimborso(cal.costo, cal.fuoriLista);
                }
                return sum;
            }, 0);
        }
        
        function calcCreditiSpesiSquadra(squadra) {
            // Somma i costi di tutti gli acquisti fatti da questa squadra
            let totale = 0;
            Object.values(appData.acquistati).forEach(acq => {
                if (acq.squadra === squadra) {
                    totale += acq.costo || 0;
                }
            });
            return totale;
        }
        
        function calcRimborso(costo, isFuoriLista = false) {
            if (costo === 1) return 1;
            
            // Determina la percentuale di rimborso
            const percentuale = isFuoriLista 
                ? appData.config.rimborsoFuoriLista 
                : appData.config.rimborsoPercentuale;
            
            const rimborsoRaw = costo * (percentuale / 100);
            
            // Applica l'arrotondamento configurato
            switch (appData.config.arrotondamento) {
                case 'ceil':
                    return Math.ceil(rimborsoRaw);
                case 'round':
                    return Math.round(rimborsoRaw);
                case 'floor':
                default:
                    return Math.floor(rimborsoRaw);
            }
        }
        
        function updateTotaleLega() {
            // Element was removed, function kept for potential future use
            const el = document.getElementById('totale-lega');
            if (!el) return;
            
            let totale = 0;
            Object.keys(appData.squadre).forEach(sq => {
                const budgetBase = appData.config.budgetSquadre[sq] || 0;
                const creditiAgg = appData.config.creditiAggiuntivi;
                const creditiRecuperati = calcCreditiRecuperatiSquadra(sq);
                totale += budgetBase + creditiAgg + creditiRecuperati;
            });
            el.textContent = totale;
        }
        
        // Keep track of expanded squadre
        function getExpandedSquadre() {
            const expanded = [];
            document.querySelectorAll('.squadra-section').forEach(section => {
                const header = section.querySelector('.squadra-header');
                if (header && !header.classList.contains('collapsed')) {
                    expanded.push(section.id);
                }
            });
            return expanded;
        }
        
        function restoreExpandedSquadre(expandedIds) {
            expandedIds.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    const header = section.querySelector('.squadra-header');
                    const content = section.querySelector('.squadra-content');
                    if (header && content) {
                        header.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                    }
                }
            });
        }
        
        function buildFantacalcioUrl(nome, squadra, id) {
            if (!nome || !squadra || !id) return null;
            
            // Normalizza squadra (lowercase, no spaces)
            const squadraNorm = squadra.toLowerCase().trim().replace(/\s+/g, '-');
            
            // Normalizza nome (lowercase, remove accents, spaces -> dash, remove apostrophes)
            const nomeNorm = nome.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/'/g, '') // Remove apostrophes
                .trim()
                .replace(/\s+/g, '-'); // Spaces to dashes
            
            return `https://www.fantacalcio.it/serie-a/squadre/${squadraNorm}/${nomeNorm}/${id}`;
        }
        
        // Cache per i dati di titolarità già caricati
        const titolaritaCache = {};
        let lastTitolaritaFetch = 0;
        const TITOLARITA_FETCH_DELAY = 2000; // 2 secondi tra richieste
        
        async function fetchTitolaritaData(playerUrl, playerName, retryCount = 0) {
            // Check cache first
            if (titolaritaCache[playerUrl]) {
                return titolaritaCache[playerUrl];
            }
            
            // Rate limiting: aspetta se l'ultima richiesta è troppo recente
            const now = Date.now();
            const timeSinceLastFetch = now - lastTitolaritaFetch;
            if (timeSinceLastFetch < TITOLARITA_FETCH_DELAY) {
                await new Promise(resolve => setTimeout(resolve, TITOLARITA_FETCH_DELAY - timeSinceLastFetch));
            }
            lastTitolaritaFetch = Date.now();
            
            try {
                const response = await fetch(PROXY_URL + encodeURIComponent(playerUrl));
                if (!response.ok) throw new Error('Errore nel caricamento');
                
                const html = await response.text();
                const data = parseTitolaritaFromHtml(html, playerName);
                
                // Cache the result
                titolaritaCache[playerUrl] = data;
                return data;
            } catch (error) {
                console.error('Errore fetch titolarità:', error);
                // Retry con backoff esponenziale (max 2 tentativi)
                if (retryCount < 2) {
                    const delay = (retryCount + 1) * 3000; // 3s, 6s
                    console.log(`Retry ${retryCount + 1} tra ${delay/1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchTitolaritaData(playerUrl, playerName, retryCount + 1);
                }
                throw error;
            }
        }
        
        function parseTitolaritaFromHtml(html, playerName) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const giornate = [];
            
            // Find all rows in player-summary-table tbody (ogni riga è una giornata)
            const rows = doc.querySelectorAll('.player-summary-table tbody tr:not(.divider)');
            
            rows.forEach((row, index) => {
                const giornata = { numero: index + 1 };
                
                // Trova la cella matchweek nella riga
                const matchweekCell = row.querySelector('.matchweek');
                if (!matchweekCell) return;
                
                // Determine status from class - se ha una classe status-X la giornata è stata disputata
                // status-0 = titolare, status-1 = subentrante, status-2 = infortunato/non disponibile
                // status-3 = infortunato, status-4 = panchina
                const hasStatus0 = matchweekCell.classList.contains('status-0');
                const hasStatus1 = matchweekCell.classList.contains('status-1');
                const hasStatus2 = matchweekCell.classList.contains('status-2'); // infortunato lungo / non disponibile
                const hasStatus3 = matchweekCell.classList.contains('status-3');
                const hasStatus4 = matchweekCell.classList.contains('status-4');
                
                // La giornata è disputata se ha uno qualsiasi degli status
                giornata.disputata = hasStatus0 || hasStatus1 || hasStatus2 || hasStatus3 || hasStatus4;
                
                // Get grade/vote dalla RIGA (non dalla cella matchweek!)
                // Il .grade è in una TD separata della stessa riga
                const grade = row.querySelector('.grade');
                const votoValue = grade ? grade.getAttribute('data-value') : null;
                giornata.voto = votoValue ? parseFloat(votoValue.replace(',', '.')) : null;
                giornata.haVoto = votoValue !== null && votoValue !== '';
                
                if (hasStatus0) {
                    giornata.status = 'titolare';
                } else if (hasStatus1) {
                    // Subentrante: distingui se ha preso voto o no
                    giornata.status = giornata.haVoto ? 'subentrante' : 'subentrante-sv'; // sv = senza voto
                } else if (hasStatus2 || hasStatus3) {
                    giornata.status = 'infortunato'; // status-2 e status-3 sono entrambi infortunio/indisponibilità
                } else if (hasStatus4) {
                    giornata.status = 'panchina';
                } else {
                    giornata.status = 'non-disputata'; // giornata non ancora giocata nel campionato
                }
                
                // Get substitution minutes dalla RIGA
                const subIn = row.querySelector('.sub-in');
                const subOut = row.querySelector('.sub-out');
                
                if (subIn) {
                    giornata.minIn = subIn.getAttribute('data-minute') || '';
                }
                if (subOut) {
                    giornata.minOut = subOut.getAttribute('data-minute') || '';
                }
                
                giornate.push(giornata);
            });
            
            return {
                playerName,
                giornate,
                timestamp: Date.now()
            };
        }
        
        function calcTitolaritaStats(data) {
            // Filtra solo le giornate DISPUTATE (quelle che hanno uno status reale)
            const giornateDisputate = data.giornate.filter(g => g.disputata);
            const totale = giornateDisputate.length;
            
            if (totale === 0) {
                return {
                    titolare: 0,
                    subentrante: 0,
                    subentranteSV: 0,
                    panchina: 0,
                    infortunato: 0,
                    totale: 0,
                    percentualeTit: 0,
                    percentualePresenza: 0,
                    percentualeVoto: 0,
                    trend: 'stable',
                    trendText: 'Dati insufficienti',
                    recentStats: null
                };
            }
            
            // Count by status sulle giornate disputate
            const titolare = giornateDisputate.filter(g => g.status === 'titolare').length;
            const subentrante = giornateDisputate.filter(g => g.status === 'subentrante').length;
            const subentranteSV = giornateDisputate.filter(g => g.status === 'subentrante-sv').length; // senza voto
            const panchina = giornateDisputate.filter(g => g.status === 'panchina').length;
            const infortunato = giornateDisputate.filter(g => g.status === 'infortunato').length;
            
            const percentualeTit = Math.round((titolare / totale) * 100);
            // Presenze CON voto (titolare + subentrante con voto)
            const presenzeConVoto = titolare + subentrante;
            const percentualePresenza = Math.round(((titolare + subentrante + subentranteSV) / totale) * 100);
            const percentualeVoto = Math.round((presenzeConVoto / totale) * 100); // % giornate con voto
            
            // ===== CALCOLO TREND AVANZATO =====
            let trend = 'stable';
            let trendText = 'Situazione stabile';
            let recentStats = null;
            
            if (giornateDisputate.length >= 3) {
                // Prendi le ultime 5 giornate DISPUTATE (o meno se non disponibili)
                const numRecent = Math.min(5, giornateDisputate.length);
                const recent = giornateDisputate.slice(-numRecent);
                
                const recentTit = recent.filter(g => g.status === 'titolare').length;
                const recentSub = recent.filter(g => g.status === 'subentrante').length;
                const recentSubSV = recent.filter(g => g.status === 'subentrante-sv').length;
                const recentPanc = recent.filter(g => g.status === 'panchina').length;
                const recentInf = recent.filter(g => g.status === 'infortunato').length;
                const recentPercTit = (recentTit / numRecent) * 100;
                const recentPercVoto = ((recentTit + recentSub) / numRecent) * 100;
                
                recentStats = {
                    titolare: recentTit,
                    subentrante: recentSub,
                    subentranteSV: recentSubSV,
                    panchina: recentPanc,
                    infortunato: recentInf,
                    percentuale: Math.round(recentPercTit),
                    percentualeVoto: Math.round(recentPercVoto),
                    giornate: recent.map(g => g.numero),
                    dettaglio: recent.map(g => ({ numero: g.numero, status: g.status }))
                };
                
                // ===== ANALISI MULTI-FATTORE =====
                let trendScore = 0; // da -100 a +100
                let trendReasons = [];
                
                // 1. CONFRONTO ULTIME 5 vs PRECEDENTI 5 (peso: 30%)
                if (giornateDisputate.length >= 8) {
                    const prev5 = giornateDisputate.slice(-10, -5);
                    if (prev5.length >= 3) {
                        const prevTit = prev5.filter(g => g.status === 'titolare').length;
                        const prevPercTit = (prevTit / prev5.length) * 100;
                        const diffVsPrev = recentPercTit - prevPercTit;
                        
                        if (diffVsPrev >= 40) {
                            trendScore += 30;
                            trendReasons.push('Netto miglioramento vs periodo precedente');
                        } else if (diffVsPrev >= 20) {
                            trendScore += 20;
                            trendReasons.push('Miglioramento vs periodo precedente');
                        } else if (diffVsPrev <= -40) {
                            trendScore -= 30;
                            trendReasons.push('Netto peggioramento vs periodo precedente');
                        } else if (diffVsPrev <= -20) {
                            trendScore -= 20;
                            trendReasons.push('Peggioramento vs periodo precedente');
                        }
                    }
                }
                
                // 2. SEQUENZA CONSECUTIVA RECENTE (peso: 25%)
                // Analizza le ultime 3 giornate per pattern
                const last3 = recent.slice(-3);
                const last3Tit = last3.filter(g => g.status === 'titolare').length;
                const last3Panc = last3.filter(g => g.status === 'panchina').length;
                const last3Inf = last3.filter(g => g.status === 'infortunato').length;
                
                if (last3Tit === 3) {
                    trendScore += 25;
                    trendReasons.push('3 titolarità consecutive');
                } else if (last3Tit >= 2 && last3[last3.length - 1].status === 'titolare') {
                    trendScore += 15;
                    trendReasons.push('Titolare nelle ultime partite');
                } else if (last3Panc === 3) {
                    trendScore -= 25;
                    trendReasons.push('3 panchine consecutive');
                } else if (last3Panc >= 2 && last3[last3.length - 1].status === 'panchina') {
                    trendScore -= 15;
                    trendReasons.push('In panchina nelle ultime partite');
                }
                
                // 3. ULTIMA GIORNATA (peso: 20%)
                const ultimaGiornata = recent[recent.length - 1];
                if (ultimaGiornata.status === 'titolare') {
                    trendScore += 10;
                } else if (ultimaGiornata.status === 'panchina') {
                    trendScore -= 15;
                    trendReasons.push('Ultima giornata in panchina');
                } else if (ultimaGiornata.status === 'infortunato') {
                    trendScore -= 10;
                    trendReasons.push('Ultima giornata infortunato');
                } else if (ultimaGiornata.status === 'subentrante-sv') {
                    trendScore -= 5;
                }
                
                // 4. RITORNO DA INFORTUNIO (peso: 15%)
                // Se era infortunato e ora gioca = positivo
                const hadRecentInjury = recent.slice(0, -1).some(g => g.status === 'infortunato');
                if (hadRecentInjury && (ultimaGiornata.status === 'titolare' || ultimaGiornata.status === 'subentrante')) {
                    trendScore += 15;
                    trendReasons.push('Tornato dall\'infortunio e subito in campo');
                } else if (recentInf >= 2) {
                    trendScore -= 15;
                    trendReasons.push('Problemi fisici ricorrenti');
                }
                
                // 5. PATTERN PROGRESSIVO (peso: 10%)
                // Verifica se c'è un trend crescente o decrescente nelle ultime giornate
                if (numRecent >= 4) {
                    const firstHalf = recent.slice(0, Math.floor(numRecent / 2));
                    const secondHalf = recent.slice(Math.floor(numRecent / 2));
                    const firstHalfTit = firstHalf.filter(g => g.status === 'titolare').length / firstHalf.length;
                    const secondHalfTit = secondHalf.filter(g => g.status === 'titolare').length / secondHalf.length;
                    
                    if (secondHalfTit > firstHalfTit + 0.3) {
                        trendScore += 10;
                        trendReasons.push('Trend in crescita progressiva');
                    } else if (secondHalfTit < firstHalfTit - 0.3) {
                        trendScore -= 10;
                        trendReasons.push('Trend in calo progressivo');
                    }
                }
                
                // ===== DETERMINA TREND FINALE =====
                if (trendScore >= 40) {
                    trend = 'positive';
                    trendText = 'In forte crescita!';
                } else if (trendScore >= 20) {
                    trend = 'positive';
                    trendText = 'Tendenza positiva';
                } else if (trendScore <= -40) {
                    trend = 'negative';
                    trendText = 'In forte calo!';
                } else if (trendScore <= -20) {
                    trend = 'negative';
                    trendText = 'Tendenza negativa';
                } else {
                    trend = 'stable';
                    trendText = 'Situazione stabile';
                }
                
                // Aggiungi motivo principale se disponibile
                if (trendReasons.length > 0) {
                    trendText += ` - ${trendReasons[0]}`;
                }
                
                // Salva info aggiuntive per debug/display
                recentStats.trendScore = trendScore;
                recentStats.trendReasons = trendReasons;
            }
            
            return {
                titolare,
                subentrante,
                subentranteSV,
                panchina,
                infortunato,
                totale,
                percentualeTit,
                percentualePresenza,
                percentualeVoto,
                trend,
                trendText,
                recentStats
            };
        }
        
        function showTitolaritaPopup(data) {
            // Remove any existing popup
            closeTitolaritaPopup();
            
            const stats = calcTitolaritaStats(data);
            
            const overlay = document.createElement('div');
            overlay.className = 'titolarita-popup-overlay';
            overlay.onclick = closeTitolaritaPopup;
            
            const popup = document.createElement('div');
            popup.className = 'titolarita-popup';
            
            // Build giornate strip - mostra solo le giornate disputate
            let giornateStrip = '<div class="giornate-strip">';
            data.giornate.forEach(g => {
                let dotClass = 'non-giocata';
                let statusText = 'Non disputata';
                
                if (g.disputata) {
                    if (g.status === 'titolare') {
                        dotClass = 'titolare';
                        statusText = 'Titolare';
                    } else if (g.status === 'subentrante') {
                        dotClass = 'subentrante';
                        statusText = 'Subentrante (con voto)';
                    } else if (g.status === 'subentrante-sv') {
                        dotClass = 'subentrante-sv';
                        statusText = 'Subentrante SENZA VOTO';
                    } else if (g.status === 'panchina') {
                        dotClass = 'panchina';
                        statusText = 'Panchina';
                    } else if (g.status === 'infortunato') {
                        dotClass = 'infortunato';
                        statusText = 'Infortunato';
                    }
                }
                
                giornateStrip += `<span class="giornata-dot ${dotClass}" title="G${g.numero}: ${statusText}">${g.numero}</span>`;
            });
            giornateStrip += '</div>';
            
            // Info sulle ultime 5 giornate disputate - dettaglio completo
            let ultime5Info = '';
            let trendDetails = '';
            if (stats.recentStats) {
                const r = stats.recentStats;
                
                // Mostra le ultime giornate con icone
                let recentIcons = r.dettaglio.map(d => {
                    if (d.status === 'titolare') return '🟢';
                    if (d.status === 'subentrante') return '🟡';
                    if (d.status === 'subentrante-sv') return '🟠';
                    if (d.status === 'panchina') return '⬛';
                    if (d.status === 'infortunato') return '🟣';
                    return '⚪';
                }).join(' ');
                
                ultime5Info = `
                    <div class="recent-games">
                        <div class="recent-games-title">Ultime ${r.giornate.length} giornate</div>
                        <div class="recent-games-icons">
                            ${recentIcons}
                            <span class="recent-games-label">G${r.giornate.join(', G')}</span>
                        </div>
                    </div>
                `;
                
                // Mostra altri motivi del trend se disponibili
                if (r.trendReasons && r.trendReasons.length > 1) {
                    trendDetails = '<div class="trend-reasons">';
                    trendDetails += r.trendReasons.slice(1).map(reason => `• ${reason}`).join('<br>');
                    trendDetails += '</div>';
                }
            }
            
            popup.innerHTML = `
                <button class="close-btn" onclick="closeTitolaritaPopup()">&times;</button>
                <h3>📊 ${data.playerName}</h3>
                
                <div class="titolarita-stats">
                    <div class="titolarita-stat titolare">
                        <div class="value">${stats.percentualeTit}%</div>
                        <div class="label">Titolarità</div>
                    </div>
                    <div class="titolarita-stat info">
                        <div class="value">${stats.percentualeVoto}%</div>
                        <div class="label">Con Voto</div>
                    </div>
                    <div class="titolarita-stat titolare">
                        <div class="value">${stats.titolare}</div>
                        <div class="label">Titolare</div>
                    </div>
                    <div class="titolarita-stat ${stats.subentranteSV > 0 ? 'mixed' : 'subentrante'}">
                        <div class="value">${stats.subentrante}${stats.subentranteSV > 0 ? `<small style="font-size:0.6em;color:var(--danger)">+${stats.subentranteSV}</small>` : ''}</div>
                        <div class="label">Subentrante</div>
                    </div>
                </div>
                
                <div class="titolarita-trend ${stats.trend}">
                    <h4>📈 Analisi Trend</h4>
                    <div class="trend-indicator ${stats.trend}">
                        <span class="trend-icon">${stats.trend === 'positive' ? '📈' : stats.trend === 'negative' ? '📉' : '➡️'}</span>
                        <span>${stats.trendText}</span>
                    </div>
                    ${ultime5Info}
                    ${trendDetails}
                </div>
                
                <div class="titolarita-detail">
                    <div class="titolarita-detail-title">📋 Dettaglio Completo (${stats.totale} giornate)</div>
                    
                    <div class="stats-breakdown">
                        ${stats.titolare > 0 ? `
                        <div class="stat-bar-item titolare">
                            <div class="stat-bar-header">
                                <span class="stat-bar-label">🟢 Titolare</span>
                                <span class="stat-bar-value">${stats.titolare}</span>
                            </div>
                            <div class="stat-bar-progress">
                                <div class="stat-bar-fill" style="width: ${(stats.titolare/stats.totale*100)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${stats.subentrante > 0 ? `
                        <div class="stat-bar-item subentrante">
                            <div class="stat-bar-header">
                                <span class="stat-bar-label">🟡 Subentrante</span>
                                <span class="stat-bar-value">${stats.subentrante}</span>
                            </div>
                            <div class="stat-bar-progress">
                                <div class="stat-bar-fill" style="width: ${(stats.subentrante/stats.totale*100)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${stats.subentranteSV > 0 ? `
                        <div class="stat-bar-item subentrante-sv">
                            <div class="stat-bar-header">
                                <span class="stat-bar-label">🟠 Sub. S.V.</span>
                                <span class="stat-bar-value">${stats.subentranteSV}</span>
                            </div>
                            <div class="stat-bar-progress">
                                <div class="stat-bar-fill" style="width: ${(stats.subentranteSV/stats.totale*100)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${stats.panchina > 0 ? `
                        <div class="stat-bar-item panchina">
                            <div class="stat-bar-header">
                                <span class="stat-bar-label">⬛ Panchina</span>
                                <span class="stat-bar-value">${stats.panchina}</span>
                            </div>
                            <div class="stat-bar-progress">
                                <div class="stat-bar-fill" style="width: ${(stats.panchina/stats.totale*100)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${stats.infortunato > 0 ? `
                        <div class="stat-bar-item infortunato">
                            <div class="stat-bar-header">
                                <span class="stat-bar-label">🟣 Infortunato</span>
                                <span class="stat-bar-value">${stats.infortunato}</span>
                            </div>
                            <div class="stat-bar-progress">
                                <div class="stat-bar-fill" style="width: ${(stats.infortunato/stats.totale*100)}%"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${giornateStrip}
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }
        
        function closeTitolaritaPopup() {
            const overlay = document.querySelector('.titolarita-popup-overlay');
            const popup = document.querySelector('.titolarita-popup');
            if (overlay) overlay.remove();
            if (popup) popup.remove();
        }
        
        async function loadPlayerTitolarita(button, playerUrl, playerName) {
            if (button.classList.contains('loading')) return;
            
            button.classList.add('loading');
            button.innerHTML = '⏳';
            
            try {
                const data = await fetchTitolaritaData(playerUrl, playerName);
                showTitolaritaPopup(data);
            } catch (error) {
                alert('Errore nel caricamento dei dati di titolarità. Riprova più tardi.');
            } finally {
                button.classList.remove('loading');
                button.innerHTML = '📊';
            }
        }
        
        function renderSquadre(preserveExpanded = false) {
            const container = document.getElementById('squadre-container');
            
            // Save expanded state before re-render
            const expandedIds = preserveExpanded ? getExpandedSquadre() : [];
            
            // Role order: P, D, C, A
            const ruoloOrder = { 'P': 1, 'D': 2, 'C': 3, 'A': 4 };
            
            container.innerHTML = Object.keys(appData.squadre).sort().map(sq => {
                const calciatori = [...appData.squadre[sq]].sort((a, b) => {
                    return (ruoloOrder[a.ruolo] || 99) - (ruoloOrder[b.ruolo] || 99);
                });
                const numSvincolati = calciatori.filter(c => appData.svincoli[c.nome]).length;
                const safeId = sq.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Count svincolati by role
                const svincolatiPerRuolo = { 'P': 0, 'D': 0, 'C': 0, 'A': 0 };
                calciatori.forEach(cal => {
                    if (appData.svincoli[cal.nome] && svincolatiPerRuolo.hasOwnProperty(cal.ruolo)) {
                        svincolatiPerRuolo[cal.ruolo]++;
                    }
                });
                
                // Build role summary badges (only show if there are svincolati)
                let roleSummary = '';
                if (numSvincolati > 0) {
                    roleSummary = '<span class="svincoli-summary">';
                    ['P', 'D', 'C', 'A'].forEach(ruolo => {
                        if (svincolatiPerRuolo[ruolo] > 0) {
                            roleSummary += `<span class="ruolo-badge ${ruolo}">${svincolatiPerRuolo[ruolo]}</span>`;
                        }
                    });
                    roleSummary += '</span>';
                }
                
                return `
                    <div class="squadra-section" id="squadra-${safeId}">
                        <div class="squadra-header collapsed" onclick="toggleSquadra('${safeId}')">
                            <h3>
                                ${sq}
                                <span class="counter">(${numSvincolati}/${calciatori.length} svincolati)</span>
                                ${roleSummary}
                            </h3>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="squadra-content collapsed">
                            <div class="squadra-actions">
                                <button class="btn-reset" onclick="resetSvincoliSquadra('${sq}')">🗑️ Reset svincoli</button>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Svincola</th>
                                        <th>Nome</th>
                                        <th>PGv</th>
                                        <th>MV</th>
                                        <th>Ruolo</th>
                                        <th>Squadra</th>
                                        <th>Costo</th>
                                        <th>Rimborso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${calciatori.map(cal => {
                                        const isSvincolato = appData.svincoli[cal.nome];
                                        const rimborso = calcRimborso(cal.costo, cal.fuoriLista);
                                        const infortunatoInfo = isInfortunato(cal.nome);
                                        const rowClass = cal.fuoriLista ? 'fuori-lista' : (isSvincolato ? 'svincolato' : '');
                                        const infortunatoClass = infortunatoInfo ? ' infortunato' : '';
                                        const nuovoArrivo = isNuovoArrivo(cal.nome, cal.squadra);
                                        const playerUrl = buildFantacalcioUrl(cal.nome, cal.squadra, cal.id);
                                        const playerLink = playerUrl ? `<a href="${playerUrl}" target="_blank" class="player-info-link" title="Vedi su Fantacalcio.it">🔍</a>` : '';
                                        const titolaritaBtn = playerUrl ? `<button class="player-titolarita-btn" onclick="loadPlayerTitolarita(this, '${playerUrl}', '${cal.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" title="Analizza titolarità">📊 Titolarità</button>` : '';
                                        return `
                                            <tr class="${rowClass}${infortunatoClass}">
                                                <td>
                                                    <input type="checkbox" 
                                                        ${isSvincolato ? 'checked' : ''} 
                                                        onchange="toggleSvincolo('${cal.nome.replace(/'/g, "\\'")}', this.checked)">
                                                </td>
                                                <td>${cal.nome}${playerLink}${titolaritaBtn}${cal.fuoriLista ? ' ⚠️' : ''}${nuovoArrivo ? '<span class="nuovo-arrivo-badge">NEW</span>' : ''}${infortunatoInfo ? `<span class="infortunato-badge" data-tooltip="${infortunatoInfo.descrizione}">🏥 INF</span>` : ''}</td>
                                                <td>${cal.pgv || '-'}</td>
                                                <td>${cal.mv ? cal.mv.toFixed(2) : '-'}</td>
                                                <td>${cal.ruolo}</td>
                                                <td>${cal.squadra}</td>
                                                <td>${cal.costo}</td>
                                                <td>${isSvincolato ? rimborso : '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Restore expanded state after re-render
            if (preserveExpanded) {
                restoreExpandedSquadre(expandedIds);
            }
        }
        
        function toggleSquadra(safeId) {
            const section = document.getElementById(`squadra-${safeId}`);
            const header = section.querySelector('.squadra-header');
            const content = section.querySelector('.squadra-content');
            
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }
        
        function toggleSvincolo(nome, checked) {
            if (checked) {
                appData.svincoli[nome] = true;
            } else {
                delete appData.svincoli[nome];
            }
            saveSvincoli();
            rebuildSvincolati();
            renderBudgetCards();
            renderSquadre(true);
            renderSvincolatiTables();
            updateTotaleLega();
            updateRiepilogoSvincoli();
        }
        
        function resetSvincoliSquadra(squadra) {
            if (!confirm(`Vuoi resettare tutti gli svincoli di ${squadra}?`)) return;
            
            const calciatori = appData.squadre[squadra] || [];
            calciatori.forEach(cal => {
                delete appData.svincoli[cal.nome];
            });
            
            saveSvincoli();
            rebuildSvincolati();
            renderBudgetCards();
            renderSquadre();
            renderSvincolatiTables();
            updateTotaleLega();
            updateRiepilogoSvincoli();
        }
        
        function updateRiepilogoSvincoli() {
            const content = document.getElementById('riepilogo-content');
            const countSpan = document.getElementById('count-svincoli');
            
            if (!content || !countSpan) return;
            
            const svincolati = [];
            Object.keys(appData.squadre).forEach(sq => {
                appData.squadre[sq].forEach(cal => {
                    if (appData.svincoli[cal.nome]) {
                        svincolati.push({
                            nome: cal.nome,
                            squadra: sq,
                            costo: cal.costo,
                            fuoriLista: cal.fuoriLista,
                            rimborso: calcRimborso(cal.costo, cal.fuoriLista)
                        });
                    }
                });
            });
            
            countSpan.textContent = svincolati.length;
            
            if (svincolati.length === 0) {
                content.innerHTML = '<div class="riepilogo-empty">Nessun calciatore svincolato</div>';
            } else {
                content.innerHTML = svincolati.map(s => `
                    <div class="riepilogo-item">
                        <span><strong>${s.nome}</strong> (${s.squadra})</span>
                        <span>Costo: ${s.costo} → Rimborso: <strong style="color: var(--success)">+${s.rimborso}</strong></span>
                    </div>
                `).join('');
            }
        }
        
        function toggleRiepilogo() {
            const content = document.getElementById('riepilogo-content');
            content.classList.toggle('collapsed');
        }
        
        // ===== QUICK SEARCH =====
        function setupQuickSearch() {
            const input = document.getElementById('quick-search');
            const list = document.getElementById('autocomplete-list');
            let selectedPlayer = null;
            let selectedIsSvincolato = false;
            
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase().trim();
                selectedPlayer = null;
                selectedIsSvincolato = false;
                
                if (query.length < 2) {
                    list.classList.remove('show');
                    updateQuickButton();
                    return;
                }
                
                // Search in all squadre (both svincolati and non)
                const matches = [];
                Object.keys(appData.squadre).forEach(sq => {
                    appData.squadre[sq].forEach(cal => {
                        if (cal.nome.toLowerCase().includes(query)) {
                            matches.push({ 
                                ...cal, 
                                fantaSquadra: sq,
                                isSvincolato: !!appData.svincoli[cal.nome]
                            });
                        }
                    });
                });
                
                if (matches.length === 0) {
                    list.classList.remove('show');
                    return;
                }
                
                list.innerHTML = matches.slice(0, 10).map(m => `
                    <div class="autocomplete-item ${m.isSvincolato ? 'svincolato' : ''}" 
                         data-nome="${m.nome.replace(/"/g, '&quot;')}"
                         data-svincolato="${m.isSvincolato}">
                        <div>
                            ${m.isSvincolato ? '🔓 ' : ''}${m.nome} (${m.ruolo})
                            ${m.isSvincolato ? '<span style="color: var(--warning); font-size: 0.8rem;"> - Svincolato</span>' : ''}
                        </div>
                        <div class="squadra">${m.fantaSquadra} - ${m.squadra}</div>
                    </div>
                `).join('');
                
                list.classList.add('show');
                
                // Handle click
                list.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectedPlayer = item.dataset.nome;
                        selectedIsSvincolato = item.dataset.svincolato === 'true';
                        input.value = selectedPlayer;
                        list.classList.remove('show');
                        updateQuickButton();
                    });
                });
            });
            
            // Store selected player for quick svincola
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value) {
                    quickSvincolaToggle();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.quick-search-wrapper')) {
                    list.classList.remove('show');
                }
            });
            
            // Update button based on selection
            function updateQuickButton() {
                const btn = document.getElementById('quick-svincola-btn');
                if (selectedIsSvincolato) {
                    btn.textContent = '↩️ Annulla';
                    btn.style.background = 'var(--warning)';
                    btn.style.color = '#000';
                } else {
                    btn.textContent = '⚡ Svincola';
                    btn.style.background = '';
                    btn.style.color = '';
                }
            }
        }
        
        function quickSvincolaToggle() {
            const input = document.getElementById('quick-search');
            const nome = input.value.trim();
            
            if (!nome) {
                alert('Seleziona un calciatore dalla lista');
                return;
            }
            
            // Find the player
            let found = false;
            Object.keys(appData.squadre).forEach(sq => {
                appData.squadre[sq].forEach(cal => {
                    if (cal.nome === nome) {
                        found = true;
                    }
                });
            });
            
            if (!found) {
                alert('Calciatore non trovato');
                return;
            }
            
            // Toggle svincolo
            const isSvincolato = !!appData.svincoli[nome];
            toggleSvincolo(nome, !isSvincolato);
            
            input.value = '';
            document.getElementById('autocomplete-list').classList.remove('show');
            
            // Reset button
            const btn = document.getElementById('quick-svincola-btn');
            btn.textContent = '⚡ Svincola';
            btn.style.background = '';
            btn.style.color = '';
        }
        
        // Legacy function for onclick
        function quickSvincola() {
            quickSvincolaToggle();
        }
        
        // ===== SVINCOLATI TABLES =====
        function renderSvincolatiTables() {
            ['P', 'D', 'C', 'A'].forEach(ruolo => {
                const tabId = RUOLI_MAP[ruolo].toLowerCase();
                renderFilters(ruolo, tabId);
                renderSvincolatiTable(ruolo, tabId);
            });
        }
        
        function renderFilters(ruolo, tabId) {
            const container = document.getElementById(`filters-${tabId}`);
            const squadreSerieA = [...new Set(appData.svincolati[ruolo].map(c => c.squadra))].sort();
            
            const hasNuoviArrivi = Object.keys(appData.nuoviArrivi).length > 0;
            
            container.innerHTML = `
                <div class="filter-group">
                    <label>Cerca</label>
                    <input type="text" id="filter-search-${tabId}" placeholder="Nome calciatore..." onkeyup="filterTable('${ruolo}', '${tabId}')">
                </div>
                <div class="filter-group">
                    <label>Squadra</label>
                    <select id="filter-squadra-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="">Tutte</option>
                        ${squadreSerieA.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label>FM min</label>
                    <input type="number" id="filter-fm-${tabId}" placeholder="0" step="0.5" onchange="filterTable('${ruolo}', '${tabId}')">
                </div>
                <div class="filter-group">
                    <label>PGv min</label>
                    <input type="number" id="filter-pgv-${tabId}" placeholder="0" onchange="filterTable('${ruolo}', '${tabId}')">
                </div>
                <div class="filter-group">
                    <label>⭐ Preferiti</label>
                    <select id="filter-preferiti-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="">Tutti</option>
                        <option value="1">⭐ 1+ stelle</option>
                        <option value="2">⭐⭐ 2+ stelle</option>
                        <option value="3">⭐⭐⭐ 3+ stelle</option>
                        <option value="4">⭐⭐⭐⭐ 4+ stelle</option>
                        <option value="5">⭐⭐⭐⭐⭐ Solo 5 stelle</option>
                    </select>
                </div>
                ${hasNuoviArrivi ? `
                <div class="filter-group">
                    <label>🆕 Mercato</label>
                    <select id="filter-nuoviarrivi-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="">Tutti</option>
                        <option value="1">Solo nuovi arrivi</option>
                    </select>
                </div>
                ` : ''}
                <div class="filter-group">
                    <label>🔓 Rilasciati</label>
                    <select id="filter-rilasciati-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="">Tutti</option>
                        <option value="1">Solo rilasciati</option>
                        <option value="0">Escludi rilasciati</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>❌ Acquistati</label>
                    <select id="filter-acquistati-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="0">Nascondi acquistati</option>
                        <option value="">Mostra tutti</option>
                        <option value="1">Solo acquistati</option>
                    </select>
                </div>
                ${Object.keys(appData.infortunati).length > 0 ? `
                <div class="filter-group">
                    <label>🏥 Infortunati</label>
                    <select id="filter-infortunati-${tabId}" onchange="filterTable('${ruolo}', '${tabId}')">
                        <option value="">Tutti</option>
                        <option value="0">Escludi infortunati</option>
                        <option value="1">Solo infortunati</option>
                    </select>
                </div>
                ` : ''}
                <div class="filter-group" style="justify-content: flex-end;">
                    <button class="btn btn-secondary btn-reset-filters" onclick="resetFilters('${ruolo}', '${tabId}')" title="Pulisci tutti i filtri">✖ Pulisci filtri</button>
                </div>
            `;
        }
        
        function renderSvincolatiTable(ruolo, tabId, sortCol = 'pgv', sortDir = 'desc') {
            const container = document.getElementById(`table-${tabId}`);
            let data = [...appData.svincolati[ruolo]];
            
            // Apply filters
            const search = document.getElementById(`filter-search-${tabId}`)?.value.toLowerCase() || '';
            const squadra = document.getElementById(`filter-squadra-${tabId}`)?.value || '';
            const fmMin = parseFloat(document.getElementById(`filter-fm-${tabId}`)?.value) || 0;
            const pgvMin = parseFloat(document.getElementById(`filter-pgv-${tabId}`)?.value) || 0;
            const preferitiMin = parseInt(document.getElementById(`filter-preferiti-${tabId}`)?.value) || 0;
            const soloNuoviArrivi = document.getElementById(`filter-nuoviarrivi-${tabId}`)?.value === '1';
            const rilasciatiFilter = document.getElementById(`filter-rilasciati-${tabId}`)?.value || '';
            const acquistatiFilter = document.getElementById(`filter-acquistati-${tabId}`)?.value ?? '0';
            const infortunatiFilter = document.getElementById(`filter-infortunati-${tabId}`)?.value || '';
            
            data = data.filter(c => {
                if (search && !c.nome.toLowerCase().includes(search)) return false;
                if (squadra && c.squadra !== squadra) return false;
                if (c.fm < fmMin) return false;
                if (c.pgv < pgvMin) return false;
                if (soloNuoviArrivi && !isNuovoArrivo(c.nome, c.squadra)) return false;
                if (rilasciatiFilter === '1' && !c.rilasciatoDa) return false;
                if (rilasciatiFilter === '0' && c.rilasciatoDa) return false;
                // Filtro acquistati
                const isAcquistato = !!appData.acquistati[c.nome];
                if (acquistatiFilter === '0' && isAcquistato) return false;
                if (acquistatiFilter === '1' && !isAcquistato) return false;
                // Filtro infortunati
                const infortunato = isInfortunato(c.nome);
                if (infortunatiFilter === '0' && infortunato) return false;
                if (infortunatiFilter === '1' && !infortunato) return false;
                if (preferitiMin > 0) {
                    const pref = appData.preferenze[c.nome] || 0;
                    if (pref < preferitiMin) return false;
                }
                return true;
            });
            
            // Add preferenza and other computed fields BEFORE sorting
            data = data.map(cal => ({
                ...cal,
                preferenza: appData.preferenze[cal.nome] || 0,
                isNuovo: isNuovoArrivo(cal.nome, cal.squadra),
                isAcquistato: !!appData.acquistati[cal.nome],
                infortunatoInfo: isInfortunato(cal.nome)
            }));
            
            // Sort - preferiti sempre in cima, poi ordina per colonna selezionata
            data.sort((a, b) => {
                // Prima ordina per preferenza (decrescente) - i preferiti vanno in cima
                if (a.preferenza !== b.preferenza) {
                    return b.preferenza - a.preferenza;
                }
                // Poi ordina per la colonna selezionata
                let valA = a[sortCol];
                let valB = b[sortCol];
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (sortDir === 'asc') return valA > valB ? 1 : -1;
                return valA < valB ? 1 : -1;
            });
            
            const columns = [
                { key: 'preferenza', label: '⭐' },
                { key: 'id', label: 'Id' },
                { key: 'nome', label: 'Nome' },
                { key: 'squadra', label: 'Sq.' },
                { key: 'pgv', label: 'PGv' },
                { key: 'mv', label: 'MV' },
                { key: 'fm', label: 'FM' },
                { key: 'fvm', label: 'FVM/1000' },
                { key: 'quot', label: 'QUOT.' },
                { key: 'indiceAffidabilita', label: 'Indice Affidabilità' },
                { key: 'azione', label: '❌' }
            ];
            
            // Genera HTML per la tabella desktop
            const tableHtml = `
                <div class="svincolati-table-desktop">
                    <table>
                        <thead>
                            <tr>
                                ${columns.map(col => `
                                    <th class="${sortCol === col.key ? 'sorted' : ''}" 
                                        onclick="sortSvincolatiTable('${ruolo}', '${tabId}', '${col.key}', '${sortCol === col.key && sortDir === 'desc' ? 'asc' : 'desc'}')">
                                        ${col.label}
                                        <span class="sort-icon">${sortCol === col.key ? (sortDir === 'desc' ? '▼' : '▲') : '↕'}</span>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(cal => {
                                const playerUrl = buildFantacalcioUrl(cal.nome, cal.squadra, cal.id);
                                const playerLink = playerUrl ? `<a href="${playerUrl}" target="_blank" class="player-info-link" title="Vedi su Fantacalcio.it">🔍</a>` : '';
                                const titolaritaBtn = playerUrl ? `<button class="player-titolarita-btn" onclick="loadPlayerTitolarita(this, '${playerUrl}', '${cal.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" title="Analizza titolarità">📊 Titolarità</button>` : '';
                                const acquistoInfo = cal.isAcquistato ? appData.acquistati[cal.nome] : null;
                                const acquistoLabel = acquistoInfo ? `${acquistoInfo.squadra} (${acquistoInfo.costo}cr)` : '';
                                return `
                                <tr class="${cal.preferenza > 0 ? 'preferito' : ''}${cal.isNuovo ? ' nuovo-arrivo' : ''}${cal.rilasciatoDa ? ' rilasciato' : ''}${cal.isAcquistato ? ' acquistato' : ''}${cal.infortunatoInfo ? ' infortunato' : ''}">
                                    <td class="stars-cell no-strike">
                                        ${renderStars(cal.nome, cal.preferenza, ruolo, tabId)}
                                    </td>
                                    <td>${cal.id}</td>
                                    <td>
                                        ${cal.nome}${playerLink}${titolaritaBtn}
                                        ${cal.isNuovo ? '<span class="nuovo-arrivo-badge">NEW</span>' : ''}
                                        ${cal.rilasciatoDa ? `<span class="rilasciato-badge" title="Rilasciato da ${cal.rilasciatoDa}">🔓 ${cal.rilasciatoDa}</span>` : ''}
                                        ${cal.isAcquistato ? `<span class="acquistato-badge" title="Acquistato da ${acquistoLabel}">→ ${acquistoLabel}</span>` : ''}
                                        ${cal.infortunatoInfo ? `<span class="infortunato-badge" data-tooltip="${cal.infortunatoInfo.descrizione}">🏥 INF</span>` : ''}
                                    </td>
                                    <td>${cal.squadra}</td>
                                    <td>${cal.pgv}</td>
                                    <td>${cal.mv.toFixed(2)}</td>
                                    <td>${cal.fm.toFixed(2)}</td>
                                    <td>${cal.fvm.toFixed(2)}</td>
                                    <td>${cal.quot}</td>
                                    <td>${cal.indiceAffidabilita.toFixed(2)}</td>
                                    <td class="no-strike">
                                        <button class="btn-acquistato ${cal.isAcquistato ? 'active' : ''}" 
                                                onclick="toggleAcquistato('${cal.nome.replace(/'/g, "\\'")}', ${cal.id}, '${cal.squadra.replace(/'/g, "\\'")}')"
                                                title="${cal.isAcquistato ? 'Modifica/rimuovi acquisto' : 'Registra acquisto'}">
                                            ${cal.isAcquistato ? '✏️' : '🛒'}
                                        </button>
                                    </td>
                                </tr>
                            `;}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Genera HTML per le card mobile
            const cardsHtml = `
                <div class="svincolati-cards-mobile">
                    <!-- Ordinamento mobile -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select onchange="sortSvincolatiTable('${ruolo}', '${tabId}', this.value.split('|')[0], this.value.split('|')[1])" style="flex: 1; padding: 10px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary);">
                            <option value="fm|desc" ${sortCol === 'fm' && sortDir === 'desc' ? 'selected' : ''}>FM ↓</option>
                            <option value="fm|asc" ${sortCol === 'fm' && sortDir === 'asc' ? 'selected' : ''}>FM ↑</option>
                            <option value="fvm|desc" ${sortCol === 'fvm' && sortDir === 'desc' ? 'selected' : ''}>FVM ↓</option>
                            <option value="fvm|asc" ${sortCol === 'fvm' && sortDir === 'asc' ? 'selected' : ''}>FVM ↑</option>
                            <option value="quot|desc" ${sortCol === 'quot' && sortDir === 'desc' ? 'selected' : ''}>Quot. ↓</option>
                            <option value="quot|asc" ${sortCol === 'quot' && sortDir === 'asc' ? 'selected' : ''}>Quot. ↑</option>
                            <option value="pgv|desc" ${sortCol === 'pgv' && sortDir === 'desc' ? 'selected' : ''}>PGv ↓</option>
                            <option value="nome|asc" ${sortCol === 'nome' && sortDir === 'asc' ? 'selected' : ''}>Nome A-Z</option>
                            <option value="preferenza|desc" ${sortCol === 'preferenza' && sortDir === 'desc' ? 'selected' : ''}>⭐ Preferiti</option>
                        </select>
                    </div>
                    
                    ${data.map((cal, index) => {
                        const playerUrl = buildFantacalcioUrl(cal.nome, cal.squadra, cal.id);
                        const acquistoInfo = cal.isAcquistato ? appData.acquistati[cal.nome] : null;
                        const acquistoLabel = acquistoInfo ? `${acquistoInfo.squadra} (${acquistoInfo.costo}cr)` : '';
                        const cardId = `card-${tabId}-${index}`;
                        
                        return `
                        <div class="player-card ${cal.preferenza > 0 ? 'preferito' : ''} ${cal.isAcquistato ? 'acquistato' : ''} ${cal.infortunatoInfo ? 'infortunato' : ''}" id="${cardId}">
                            <div class="player-card-header" onclick="togglePlayerCard('${cardId}')">
                                <div class="player-card-main">
                                    <div>
                                        <div class="player-card-name">
                                            ${cal.nome}
                                            <span class="badges">
                                                ${cal.preferenza > 0 ? `<span style="color: var(--gold);">${'★'.repeat(cal.preferenza)}</span>` : ''}
                                                ${cal.isNuovo ? '<span class="nuovo-arrivo-badge">NEW</span>' : ''}
                                                ${cal.infortunatoInfo ? '<span style="color: #9c27b0;">🏥</span>' : ''}
                                            </span>
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">
                                            <span class="player-card-squadra">${cal.squadra}</span>
                                            ${cal.rilasciatoDa ? `<span style="font-size: 0.75rem; color: var(--warning);">🔓 ${cal.rilasciatoDa}</span>` : ''}
                                            ${cal.isAcquistato ? `<span style="font-size: 0.75rem; color: var(--success);">→ ${acquistoLabel}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="player-card-stats">
                                    <div class="player-card-stat highlight">
                                        <div class="value">${cal.fm.toFixed(1)}</div>
                                        <div class="label">FM</div>
                                    </div>
                                    <div class="player-card-stat">
                                        <div class="value">${cal.pgv}</div>
                                        <div class="label">PGv</div>
                                    </div>
                                    <span class="player-card-expand">▼</span>
                                </div>
                            </div>
                            <div class="player-card-body">
                                <div class="player-card-details">
                                    ${cal.infortunatoInfo ? `
                                        <div class="player-card-info-badges">
                                            <span style="background: rgba(156, 39, 176, 0.2); color: #ce93d8; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem;">
                                                🏥 ${cal.infortunatoInfo.descrizione}
                                            </span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="player-card-details-grid">
                                        <div class="player-card-detail">
                                            <div class="value">${cal.pgv}</div>
                                            <div class="label">PGv</div>
                                        </div>
                                        <div class="player-card-detail">
                                            <div class="value">${cal.mv.toFixed(2)}</div>
                                            <div class="label">MV</div>
                                        </div>
                                        <div class="player-card-detail">
                                            <div class="value" style="color: var(--gold);">${cal.fvm.toFixed(2)}</div>
                                            <div class="label">FVM/1000</div>
                                        </div>
                                        <div class="player-card-detail">
                                            <div class="value">${cal.quot}</div>
                                            <div class="label">Quotaz.</div>
                                        </div>
                                        <div class="player-card-detail">
                                            <div class="value">${cal.indiceAffidabilita.toFixed(1)}</div>
                                            <div class="label">Affidab.</div>
                                        </div>
                                        <div class="player-card-detail">
                                            <div class="value" style="font-size: 0.9rem; color: var(--text-secondary);">#${cal.id}</div>
                                            <div class="label">ID</div>
                                        </div>
                                    </div>
                                    
                                    <div class="player-card-bottom">
                                        <div class="player-card-stars">
                                            ${renderStarsMobile(cal.nome, cal.preferenza, ruolo, tabId)}
                                        </div>
                                        <div class="player-card-links">
                                            ${playerUrl ? `
                                                <a href="${playerUrl}" target="_blank" style="background: var(--bg-card); color: var(--accent); text-decoration: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem;">
                                                    🔍 Scheda
                                                </a>
                                                <button class="player-titolarita-btn" onclick="loadPlayerTitolarita(this, '${playerUrl}', '${cal.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding: 8px 12px;">
                                                    📊 Titolarità
                                                </button>
                                            ` : ''}
                                            <button class="btn-acquistato ${cal.isAcquistato ? 'active' : ''}" 
                                                    onclick="toggleAcquistato('${cal.nome.replace(/'/g, "\\'")}', ${cal.id}, '${cal.squadra.replace(/'/g, "\\'")}'); event.stopPropagation();">
                                                ${cal.isAcquistato ? '✏️ Modifica' : '🛒 Acquista'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            `;
            
            container.innerHTML = `
                <p style="margin-bottom: 10px; color: var(--text-secondary)">Trovati: ${data.length} calciatori</p>
                ${tableHtml}
                ${cardsHtml}
            `;
        }
        
        function renderStars(nome, current, ruolo, tabId) {
            let html = '<div class="stars-rating">';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= current;
                html += `<span class="star ${filled ? 'filled' : ''}" onclick="setPreferenza('${nome.replace(/'/g, "\\'")}', ${i}, '${ruolo}', '${tabId}')">${filled ? '★' : '☆'}</span>`;
            }
            if (current > 0) {
                html += `<span class="star-clear" onclick="setPreferenza('${nome.replace(/'/g, "\\'")}', 0, '${ruolo}', '${tabId}')" title="Rimuovi">✕</span>`;
            }
            html += '</div>';
            return html;
        }
        
        function renderStarsMobile(nome, current, ruolo, tabId) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= current;
                html += `<span class="star ${filled ? 'filled' : ''}" onclick="setPreferenza('${nome.replace(/'/g, "\\'")}', ${i}, '${ruolo}', '${tabId}'); event.stopPropagation();">${filled ? '★' : '☆'}</span>`;
            }
            if (current > 0) {
                html += `<span class="star-clear" onclick="setPreferenza('${nome.replace(/'/g, "\\'")}', 0, '${ruolo}', '${tabId}'); event.stopPropagation();" title="Rimuovi">✕</span>`;
            }
            return html;
        }
        
        function togglePlayerCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('expanded');
            }
        }
        
        function setPreferenza(nome, value, ruolo, tabId) {
            if (value === 0) {
                delete appData.preferenze[nome];
            } else {
                appData.preferenze[nome] = value;
            }
            savePreferenze();
            // Usa l'ordinamento corrente salvato
            const sort = currentSort[tabId] || { col: 'pgv', dir: 'desc' };
            renderSvincolatiTable(ruolo, tabId, sort.col, sort.dir);
        }
        
        function toggleAcquistato(nome, id, squadraSerieA) {
            // Se già acquistato, apri il modal per modificare/rimuovere
            // Altrimenti apri il modal per registrare l'acquisto
            openAcquistoModal(nome, id, squadraSerieA);
        }
        
        function openAcquistoModal(nome, id, squadraSerieA) {
            // Rimuovi eventuali modal esistenti
            closeAcquistoModal();
            
            const existingAcquisto = appData.acquistati[nome];
            const isEdit = !!existingAcquisto;
            
            const overlay = document.createElement('div');
            overlay.className = 'acquisto-modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) closeAcquistoModal(); };
            
            const squadreOptions = Object.keys(appData.squadre).sort().map(sq => 
                `<option value="${sq}" ${existingAcquisto?.squadra === sq ? 'selected' : ''}>${sq}</option>`
            ).join('');
            
            const modal = document.createElement('div');
            modal.className = 'acquisto-modal';
            modal.innerHTML = `
                <h3>${isEdit ? '✏️ Modifica Acquisto' : '🛒 Registra Acquisto'}</h3>
                <div class="player-name">${nome}</div>
                ${squadraSerieA ? `<div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">Squadra Serie A: ${squadraSerieA}</div>` : ''}
                
                <div class="form-group">
                    <label>Squadra che acquista</label>
                    <select id="acquisto-squadra">
                        <option value="">-- Seleziona squadra --</option>
                        ${squadreOptions}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Prezzo d'acquisto</label>
                    <input type="number" id="acquisto-costo" min="1" placeholder="Crediti" value="${existingAcquisto?.costo || ''}">
                </div>
                
                <div class="buttons">
                    <button class="btn-cancel" onclick="closeAcquistoModal()">Annulla</button>
                    ${isEdit ? `<button class="btn-remove" onclick="removeAcquisto('${nome.replace(/'/g, "\\'")}')">🗑️ Rimuovi</button>` : ''}
                    <button class="btn-confirm" onclick="confirmAcquisto('${nome.replace(/'/g, "\\'")}', ${id})">
                        ${isEdit ? '💾 Salva' : '✅ Conferma'}
                    </button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus sul primo campo
            setTimeout(() => {
                if (!existingAcquisto) {
                    document.getElementById('acquisto-squadra').focus();
                } else {
                    document.getElementById('acquisto-costo').focus();
                }
            }, 100);
        }
        
        function closeAcquistoModal() {
            const overlay = document.querySelector('.acquisto-modal-overlay');
            if (overlay) overlay.remove();
        }
        
        function confirmAcquisto(nome, id) {
            const squadra = document.getElementById('acquisto-squadra').value;
            const costo = parseInt(document.getElementById('acquisto-costo').value);
            
            if (!squadra) {
                alert('Seleziona una squadra');
                return;
            }
            if (!costo || costo < 1) {
                alert('Inserisci un prezzo valido (minimo 1)');
                return;
            }
            
            appData.acquistati[nome] = {
                id: id,
                nome: nome,
                squadra: squadra,
                costo: costo
            };
            
            saveAcquistati();
            closeAcquistoModal();
            renderBudgetCards();
            renderSvincolatiTables();
            updateRiepilogoAcquisti();
        }
        
        function removeAcquisto(nome) {
            delete appData.acquistati[nome];
            saveAcquistati();
            closeAcquistoModal();
            renderBudgetCards();
            renderSvincolatiTables();
            updateRiepilogoAcquisti();
        }
        
        function saveAcquistati() {
            const key = getStorageKey('acquistati');
            if (key) localStorage.setItem(key, JSON.stringify(appData.acquistati));
        }
        
        function updateRiepilogoAcquisti() {
            const content = document.getElementById('riepilogo-acquisti-content');
            const countSpan = document.getElementById('count-acquisti');
            
            if (!content || !countSpan) return;
            
            const acquisti = Object.values(appData.acquistati);
            countSpan.textContent = acquisti.length;
            
            if (acquisti.length === 0) {
                content.innerHTML = '<div class="riepilogo-empty">Nessun acquisto registrato</div>';
            } else {
                // Raggruppa per squadra acquirente
                const perSquadra = {};
                acquisti.forEach(acq => {
                    if (!perSquadra[acq.squadra]) perSquadra[acq.squadra] = [];
                    perSquadra[acq.squadra].push(acq);
                });
                
                let html = '';
                Object.keys(perSquadra).sort().forEach(squadra => {
                    const acqSquadra = perSquadra[squadra];
                    const totaleSquadra = acqSquadra.reduce((sum, a) => sum + a.costo, 0);
                    
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: bold; color: var(--accent); margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>${squadra}</span>
                        <span style="color: var(--success);">Totale: ${totaleSquadra} cr</span>
                    </div>`;
                    
                    acqSquadra.forEach(acq => {
                        html += `
                            <div class="acquisto-item">
                                <div class="acquisto-info">
                                    <div class="acquisto-nome">${acq.nome}</div>
                                </div>
                                <div class="acquisto-costo">${acq.costo} cr</div>
                                <button class="acquisto-remove" onclick="removeAcquisto('${acq.nome.replace(/'/g, "\\'")}'); event.stopPropagation();" title="Rimuovi acquisto">✕</button>
                            </div>
                        `;
                    });
                    html += `</div>`;
                });
                
                content.innerHTML = html;
            }
        }
        
        function toggleRiepilogoAcquisti() {
            const content = document.getElementById('riepilogo-acquisti-content');
            content.classList.toggle('collapsed');
        }
        
        function filterTable(ruolo, tabId) {
            renderSvincolatiTable(ruolo, tabId);
        }
        
        function resetFilters(ruolo, tabId) {
            // Reset tutti i campi filtro ai valori di default
            const search = document.getElementById(`filter-search-${tabId}`);
            if (search) search.value = '';
            
            const squadra = document.getElementById(`filter-squadra-${tabId}`);
            if (squadra) squadra.value = '';
            
            const fm = document.getElementById(`filter-fm-${tabId}`);
            if (fm) fm.value = '';
            
            const pgv = document.getElementById(`filter-pgv-${tabId}`);
            if (pgv) pgv.value = '';
            
            const preferiti = document.getElementById(`filter-preferiti-${tabId}`);
            if (preferiti) preferiti.value = '';
            
            const nuoviArrivi = document.getElementById(`filter-nuoviarrivi-${tabId}`);
            if (nuoviArrivi) nuoviArrivi.value = '';
            
            const rilasciati = document.getElementById(`filter-rilasciati-${tabId}`);
            if (rilasciati) rilasciati.value = '';
            
            const acquistati = document.getElementById(`filter-acquistati-${tabId}`);
            if (acquistati) acquistati.value = '0'; // Default: nascondi acquistati
            
            const infortunati = document.getElementById(`filter-infortunati-${tabId}`);
            if (infortunati) infortunati.value = '';
            
            // Reset anche l'ordinamento al default
            currentSort[tabId] = { col: 'pgv', dir: 'desc' };
            
            // Ri-renderizza la tabella
            filterTable(ruolo, tabId);
        }
        
        function sortSvincolatiTable(ruolo, tabId, col, dir) {
            // Salva l'ordinamento corrente
            currentSort[tabId] = { col, dir };
            renderSvincolatiTable(ruolo, tabId, col, dir);
        }
        
        // ===== STATISTICS =====
        // ===== TABS =====
        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tabBtn) tabBtn.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchToTab(tab.dataset.tab);
            });
        });
    </script>
</body>
</html>
